<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="google-site-verification" content="6DIBzCM2sFIHFrOECCKoODFkMjWkvkmxMqJD0EFb7xU">
<style>
  html{line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,header,nav,section{display:block}h1{font-size:2em;margin:.67em 0}a{background-color:transparent;-webkit-text-decoration-skip:objects}svg:not(:root){overflow:hidden}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}.border-box,a,article,body,div,h1,header,html,p,section{-webkit-box-sizing:border-box;box-sizing:border-box}.cover{background-size:cover!important}.db{display:block}.dib{display:inline-block}.dt{display:table}.dtc{display:table-cell}@media screen and (min-width:60em){.dt-l{display:table}.dtc-l{display:table-cell}}.serif{font-family:Merriweather,georgia,times,serif}.i{font-style:italic}.fs-normal{font-style:normal}.vh-75{height:75vh}.tracked{letter-spacing:.1em}.lh-title{line-height:1.25}.lh-copy{line-height:1.5}.link{color:#f63545;text-decoration:none}.mw7{max-width:768px;max-width:48rem}.w-100{width:100%}.relative{position:relative}.dark-gray{color:#333}.mid-gray{color:#555}.pa3{padding:16px;padding:1rem}.ph0{padding-left:0;padding-right:0}.ph2{padding-left:8px;padding-left:.5rem;padding-right:8px;padding-right:.5rem}.ph3{padding-left:16px;padding-left:1rem;padding-right:16px;padding-right:1rem}.mr3{margin-right:16px;margin-right:1rem}.mb2{margin-bottom:8px;margin-bottom:.5rem}.mh0{margin-left:0;margin-right:0}@media screen and (min-width:60em){.mr4-l{margin-right:2rem}.mb0-l{margin-bottom:0}}.tr{text-align:right}.tc{text-align:center}@media screen and (min-width:60em){.tl-l{text-align:left}.tr-l{text-align:right}}.ttu{text-transform:uppercase}.f1{font-size:48px;font-size:3rem}.f3{font-size:24px;font-size:1.5rem}.f4{font-size:20px;font-size:1.25rem}.f5{font-size:16px;font-size:1rem}.f6{font-size:14px;font-size:.875rem}@media screen and (min-width:60em){.f-headline-l{font-size:4rem}.f5-l{font-size:1rem}}.measure{max-width:30em}.center{margin-right:auto;margin-left:auto}.nowrap{white-space:nowrap}.v-mid{vertical-align:middle}h1{font-weight:400}.dark-gold{color:#5a440d}.m0-auto{margin:0 auto}.measure-66ch{max-width:66ch}
</style>
<link rel="preload" href="/css/main.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="/css/main.css"></noscript>
<link rel="preload" href="/css/prism.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="/css/prism.css"></noscript>
<link rel="preload" href="/css/latex.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="/css/latex.css"></noscript>
<link href="https://fonts.googleapis.com/css?family=Merriweather:400,400i,700" rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link href="https://fonts.googleapis.com/css?family=Merriweather:400,400i,700" rel="stylesheet"></noscript>
<script>!function(n){"use strict";n.loadCSS||(n.loadCSS=function(){});var t,o=loadCSS.relpreload={};o.support=function(){var e;try{e=n.document.createElement("link").relList.supports("preload")}catch(t){e=!1}return function(){return e}}(),o.bindMediaToggle=function(t){var e=t.media||"all";function a(){t.addEventListener?t.removeEventListener("load",a):t.attachEvent&&t.detachEvent("onload",a),t.setAttribute("onload",null),t.media=e}t.addEventListener?t.addEventListener("load",a):t.attachEvent&&t.attachEvent("onload",a),setTimeout(function(){t.rel="stylesheet",t.media="only x"}),setTimeout(a,3e3)},o.poly=function(){if(!o.support())for(var t=n.document.getElementsByTagName("link"),e=0;e<t.length;e++){var a=t[e];"preload"!==a.rel||"style"!==a.getAttribute("as")||a.getAttribute("data-loadcss")||(a.setAttribute("data-loadcss",!0),o.bindMediaToggle(a))}},o.support()||(o.poly(),t=n.setInterval(o.poly,500),n.addEventListener?n.addEventListener("load",function(){o.poly(),n.clearInterval(t)}):n.attachEvent&&n.attachEvent("onload",function(){o.poly(),n.clearInterval(t)})),"undefined"!=typeof exports?exports.loadCSS=loadCSS:n.loadCSS=loadCSS}("undefined"!=typeof global?global:this);</script>

<!-- Favicons -->
<link rel="apple-touch-icon" sizes="180x180" href="/images/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/images/icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/images/icons/favicon-16x16.png">
<link rel="mask-icon" href="/images/icons/safari-pinned-tab.svg" color="#5bbad5">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Jiayi's Chronicles">

<meta name="msapplication-TileColor" content="#ffffff">
<meta name="theme-color" content="#ffffff">

<link rel="manifest" href="/manifest.json">

    <title>Install k3s with Alpine Linux on Raspberry Pi 3B+ | Jiayi's Chronicles</title>
    <!-- Search Engine -->
<meta name="description" content="A step to step guide to run k3s on Alpine Linux using Ansible playbook">
<!-- Schema.org for Google -->
<meta itemprop="name" content="Install k3s with Alpine Linux on Raspberry Pi 3B+">
<meta itemprop="description" content="A step to step guide to run k3s on Alpine Linux using Ansible playbook">
<!-- Twitter -->
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Install k3s with Alpine Linux on Raspberry Pi 3B+">
<meta name="twitter:description" content="A step to step guide to run k3s on Alpine Linux using Ansible playbook">
<meta name="twitter:site" content="@jiayi_ghu">
<meta name="twitter:image:src" content="http://blog.jiayihu.net/images/k3s-alpine-linux-raspberry/cover.png">
<!-- Open Graph general (Facebook, Pinterest & Google+) -->
<meta name="og:title" content="Install k3s with Alpine Linux on Raspberry Pi 3B+">
<meta name="og:description" content="A step to step guide to run k3s on Alpine Linux using Ansible playbook">
<meta name="og:image" content="http://blog.jiayihu.net/images/k3s-alpine-linux-raspberry/cover.png">
<meta name="og:url" content="http://blog.jiayihu.net/install-k3s-with-alpine-linux-on-raspberry-pi-3b">
<meta name="og:site_name" content="Jiayi's Chronicles">
<meta name="og:type" content="website">

    <meta name="Description" content="A step to step guide to run k3s on Alpine Linux using Ansible playbook">
  </head>

  <body class="page--article dark-grey lh-copy">
    <nav class="db dt-l w-100 border-box pa3 mw7 m0-auto">
  <a class="db dtc-l v-mid mid-gray link serif underline-hover w-100 tc tl-l mb2 mb0-l f3 nowrap" href="/" title="Home">
    Jiayi's Chronicles
  </a>
  <div class="db dtc-l nowrap v-mid w-100 tc tr-l">
    <a class="link underline-hover dark-gray f6 f5-l dib mr3 mr4-l" href="/" title="Home">Home</a>
    <a class="link underline-hover dark-gray f6 f5-l dib mr3 mr4-l" href="/about" title="About me">About me</a>
  </div>
</nav>


    <article>
      <header class="vh-75 dt w-100 tc cover">
        <div class="article__header dark-gold dtc v-mid">
          <h1 class="article__title f1 f-headline-l i lh-title ph3">
            Install k3s with Alpine Linux on Raspberry Pi 3B+
          </h1>
          <div class="ph0 mh0 measure f4 lh-copy center">
            <p class="article__subtitle abstract">
              A step to step guide to run k3s on Alpine Linux using Ansible playbook
            </p>
            <p class="article-meta author f6 ttu tracked fs-normal">
              Jiayi Hu - Dec 19th 2020
            </p>
          </div>
        </div>
      </header>
      <section class="article-main f5 lh-copy ph2 relative">
        <div class="center measure-66ch m0-auto">
          <div class="tr">
            <a href="https://github.com/jiayihu/blog/tree/master/src/articles/k3s-alpine-linux-raspberry.md" class="color-inherit f6 no-underline underline-hover glow" target="_blank" rel="noopener noreferrer">
              <span class="dib w1">
                <svg
                  viewBox="0 0 256 250"
                  version="1.1"
                  xmlns="http://www.w3.org/2000/svg"
                  xmlns:xlink="http://www.w3.org/1999/xlink"
                  preserveAspectRatio="xMidYMid"
                >
                  <g>
                    <path
                      d="M128.00106,0 C57.3172926,0 0,57.3066942 0,128.00106 C0,184.555281 36.6761997,232.535542 87.534937,249.460899 C93.9320223,250.645779 96.280588,246.684165 96.280588,243.303333 C96.280588,240.251045 96.1618878,230.167899 96.106777,219.472176 C60.4967585,227.215235 52.9826207,204.369712 52.9826207,204.369712 C47.1599584,189.574598 38.770408,185.640538 38.770408,185.640538 C27.1568785,177.696113 39.6458206,177.859325 39.6458206,177.859325 C52.4993419,178.762293 59.267365,191.04987 59.267365,191.04987 C70.6837675,210.618423 89.2115753,204.961093 96.5158685,201.690482 C97.6647155,193.417512 100.981959,187.77078 104.642583,184.574357 C76.211799,181.33766 46.324819,170.362144 46.324819,121.315702 C46.324819,107.340889 51.3250588,95.9223682 59.5132437,86.9583937 C58.1842268,83.7344152 53.8029229,70.715562 60.7532354,53.0843636 C60.7532354,53.0843636 71.5019501,49.6441813 95.9626412,66.2049595 C106.172967,63.368876 117.123047,61.9465949 128.00106,61.8978432 C138.879073,61.9465949 149.837632,63.368876 160.067033,66.2049595 C184.49805,49.6441813 195.231926,53.0843636 195.231926,53.0843636 C202.199197,70.715562 197.815773,83.7344152 196.486756,86.9583937 C204.694018,95.9223682 209.660343,107.340889 209.660343,121.315702 C209.660343,170.478725 179.716133,181.303747 151.213281,184.472614 C155.80443,188.444828 159.895342,196.234518 159.895342,208.176593 C159.895342,225.303317 159.746968,239.087361 159.746968,243.303333 C159.746968,246.709601 162.05102,250.70089 168.53925,249.443941 C219.370432,232.499507 256,184.536204 256,128.00106 C256,57.3066942 198.691187,0 128.00106,0 Z M47.9405593,182.340212 C47.6586465,182.976105 46.6581745,183.166873 45.7467277,182.730227 C44.8183235,182.312656 44.2968914,181.445722 44.5978808,180.80771 C44.8734344,180.152739 45.876026,179.97045 46.8023103,180.409216 C47.7328342,180.826786 48.2627451,181.702199 47.9405593,182.340212 Z M54.2367892,187.958254 C53.6263318,188.524199 52.4329723,188.261363 51.6232682,187.366874 C50.7860088,186.474504 50.6291553,185.281144 51.2480912,184.70672 C51.8776254,184.140775 53.0349512,184.405731 53.8743302,185.298101 C54.7115892,186.201069 54.8748019,187.38595 54.2367892,187.958254 Z M58.5562413,195.146347 C57.7719732,195.691096 56.4895886,195.180261 55.6968417,194.042013 C54.9125733,192.903764 54.9125733,191.538713 55.713799,190.991845 C56.5086651,190.444977 57.7719732,190.936735 58.5753181,192.066505 C59.3574669,193.22383 59.3574669,194.58888 58.5562413,195.146347 Z M65.8613592,203.471174 C65.1597571,204.244846 63.6654083,204.03712 62.5716717,202.981538 C61.4524999,201.94927 61.1409122,200.484596 61.8446341,199.710926 C62.5547146,198.935137 64.0575422,199.15346 65.1597571,200.200564 C66.2704506,201.230712 66.6095936,202.705984 65.8613592,203.471174 Z M75.3025151,206.281542 C74.9930474,207.284134 73.553809,207.739857 72.1039724,207.313809 C70.6562556,206.875043 69.7087748,205.700761 70.0012857,204.687571 C70.302275,203.678621 71.7478721,203.20382 73.2083069,203.659543 C74.6539041,204.09619 75.6035048,205.261994 75.3025151,206.281542 Z M86.046947,207.473627 C86.0829806,208.529209 84.8535871,209.404622 83.3316829,209.4237 C81.8013,209.457614 80.563428,208.603398 80.5464708,207.564772 C80.5464708,206.498591 81.7483088,205.631657 83.2786917,205.606221 C84.8005962,205.576546 86.046947,206.424403 86.046947,207.473627 Z M96.6021471,207.069023 C96.7844366,208.099171 95.7267341,209.156872 94.215428,209.438785 C92.7295577,209.710099 91.3539086,209.074206 91.1652603,208.052538 C90.9808515,206.996955 92.0576306,205.939253 93.5413813,205.66582 C95.054807,205.402984 96.4092596,206.021919 96.6021471,207.069023 Z"
                      fill="#161614"
                    ></path>
                  </g>
                </svg>
              </span>
              Edit on GitHub
            </a>
          </div>
          <div class="article-content"><p>I&#39;ve been recently started experimenting with Raspberry Pi 3B+ and Kubernetes for my thesis. Because of the constrained resources on devices like the Pis, I&#39;ve chosen <a class="dim" href="https://k3s.io/">K3s</a> as Kubernetes distribution meant for IoT and Edge, though I have more to say about that later.</p>
<p>Setting up Ubuntu Server and K3s on the Raspberry Pi cluster was pretty straightforward thanks to <a class="dim" href="https://github.com/k3s-io/k3s-ansible">k3s-ansible</a>. I&#39;ve started using Ansible only recently, but I&#39;m loving it. It&#39;s a well-done configuration management tool that makes configuring and running commands on the nodes much more effortless. You can run commands across all the nodes or define automated configuration called <a class="dim" href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html">playbooks</a>. We&#39;re going to use it in this blog post.</p>
<p>Because of the limited available RAM (1GB on my Pi 3B+), I decided to migrate from Ubuntu Server to Alpine Linux. Ubuntu Server was eating about ~400MB, whereas k3s server uses an additional ~400MB even without any application running. K3s agent is around 128MB of memory usage. That doesn&#39;t leave very much memory available con the server, even before running other applications like Prometheus monitoring. That&#39;s why I decided to move to <a class="dim" href="https://alpinelinux.org/">Alpine Linux</a>, which is often used as base image in containers because it&#39;s very minimal and lightweight. It takes about 120MB uncompressed and it uses only about 50MB of RAM in my case. It can be even less resource-demanding if one is using the container distribution, such as only 8MB of RAM.</p>
<p>Let&#39;s cut the crap and jump to the point.</p>
<h2 id="installing">Installing</h2>
<p>Download your favourite Alpine Linux distribution at <a class="dim" href="https://alpinelinux.org/downloads/">https://alpinelinux.org/downloads/</a>. The distribution I&#39;ve picked is <code class="purple">aarch64</code> since the Raspberry Pi 3B+ has 64bit cores.</p>
<p>After having unzipped the files, copy them over to the SD card. Remove the SD card and boot the Pi with it.</p>
<p>After the initial setup with <code class="purple">setup-alpine</code> run the following commands.</p>
<p>Update the packages:</p>
<pre><code>apk update
apk upgrade
</code></pre><p>Enable root SSH so that we can continue the following commands on our usual laptop/computer. Alpine Linux uses <a class="dim" href="https://docs.alpinelinux.org/user-handbook/0.1a/Working/openrc.html">OpenRC</a> instead of <code class="purple">systemd</code>, therefore we&#39;ll have to restart the <code class="purple">sshd</code> service with <code class="purple">rc-service</code>.</p>
<pre><code>vi /etc/ssh/sshd_config
rc-service sshd restart
</code></pre><p>Add <code class="purple">/etc/init.d</code> and <code class="purple">add /root/.ssh</code> to <code class="purple">lbu</code>. lbu is the <a class="dim" href="https://wiki.alpinelinux.org/wiki/Alpine_local_backup">Alpine local backup</a> because it&#39;s diskless by default, meaning that all the modifications must be saved to an overlay file (.apkovl) to make them survive a reboot.</p>
<p>You can try different instructions at <a class="dim" href="https://wiki.alpinelinux.org/wiki/Raspberry_Pi_4_-_Persistent_system_acting_as_a_NAS_and_Time_Machine">Raspberry Pi 4 - Persistent system acting as a NAS and Time Machine</a> if you want a fully classic persistent filesystem, but you have to start from scratch making the partitions. Personally, I was able to create the partitions but then I had issues with the <code class="purple">wlan0</code> not working, but I didn&#39;t actually invest very much time to investigate the issue.</p>
<p>What we&#39;re configuring in this blog post is a diskless minimal Alpine Linux. We&#39;ll manually commit changes so that we can&#39;t check and choose what to actually persist after a reboot. Then we&#39;ll create an automatically persisted <a class="dim" href="https://wiki.archlinux.org/index.php/Overlay_filesystem">Overlay filesystem</a> for only some specific folders:</p>
<ul>
<li><code class="purple">/root</code> the home root where we download binaries</li>
<li><code class="purple">/var/lib/rancher</code> where k3s saves data</li>
<li><code class="purple">/usr</code> to save packages in the overlay layer instead of the lbu backup, but it&#39;s optional</li>
</ul>
<p>This configuration allows having a minimal Alpine Linux reset after each reboot, whereas k3s will be saved in the overlay layer. So after a reboot, k3s will still have the information like authentication token, node passwords, DNS records etc. kept. However, in case of trouble, the overlay layer can be deleted, the system reset with reboot and k3s reinstalled automatically using Ansible.</p>
<p>Add <code class="purple">/etc/init.d</code> and <code class="purple">/root/.ssh</code> to the folders included by lbu. By default it tracks only <code class="purple">/etc</code>, with <code class="purple">/etc/init.d</code> excluded. We also set the lbu backup-limit up to 5 versions, so that you don&#39;t always need to overwrite the previous backup if you are experimenting with some changes.</p>
<pre><code>lbu add /etc/init.d
lbu add /root/.ssh
vi /etc/lbu/lbu.conf # BACKUP_LIMIT=5
</code></pre><p>Register the <code class="purple">wpa_supplicant</code> service, otherwise, in my case I wasn&#39;t able to get a DHCP lease from the wifi after reboot. More info is available at <a class="dim" href="https://gitlab.alpinelinux.org/alpine/aports/-/issues/8025">https://gitlab.alpinelinux.org/alpine/aports/-/issues/8025</a>, with also an example of what to write in <code class="purple">/etc/init.d/networking</code>.</p>
<pre><code># Add wpa_supplicant service
rc-update add wpa_supplicant default
vi /etc/init.d/networking # need wpa_supplicant
rc-update -u
lbu ci -d
</code></pre><p>Restrict SSH login with SSH key, disabling password authentication: <code class="purple">ssh-copy-id root@192.168.1.100</code>. This needs to be run in your laptop, not within the SSH session and <code class="purple">192.168.1.100</code> is the IP address of the Raspberry Pi.</p>
<p>After the key have been copied, check it is at <code class="purple">~/.ssh/authorized_keys</code>. The disable password authentication.</p>
<pre><code>vi /etc/ssh/sshd_config # PasswordAuthentication no
rc-service sshd restart
</code></pre><p>Install python needed by Ansible</p>
<pre><code>apk add python3
</code></pre><p>Now let&#39;s create the Overlay filesystem. Commands are adapted from <a class="dim" href="https://wiki.alpinelinux.org/wiki/Raspberry_Pi#Persistent_storage">https://wiki.alpinelinux.org/wiki/Raspberry_Pi#Persistent_storage</a>:</p>
<pre><code>mount /media/mmcblk0p1 -o rw,remount
sed -i &#39;s/vfat\ ro,/vfat\ rw,/&#39; /etc/fstab
dd if=/dev/zero of=/media/mmcblk0p1/persist.img bs=1024 count=0 seek=1048576
apk add e2fsprogs
mkfs.ext4 /media/mmcblk0p1/persist.img
echo &quot;/media/mmcblk0p1/persist.img /media/persist ext4 rw,relatime,errors=remount-ro 0 0&quot; &gt;&gt; /etc/fstab
mkdir /media/persist 
mount -a

# Persist /usr
mkdir /media/persist/usr
mkdir /media/persist/.work
echo &quot;overlay /usr overlay lowerdir=/usr,upperdir=/media/persist/usr,workdir=/media/persist/.work 0 0&quot; &gt;&gt; /etc/fstab 
mount -a

# Persist /var/lib/rancher
mkdir /media/persist/rancher 
mkdir /media/persist/.work-rancher
mkdir /var/lib/rancher
echo &quot;overlay /var/lib/rancher overlay lowerdir=/var/lib/rancher,upperdir=/media/persist/rancher,workdir=/media/persist/.work-rancher 0 0&quot; &gt;&gt; /etc/fstab 
mount -a

# Persist /root
mkdir /media/persist/root 
mkdir /media/persist/.work-root
echo &quot;overlay /root overlay lowerdir=/root,upperdir=/media/persist/root,workdir=/media/persist/.work-root 0 0&quot; &gt;&gt; /etc/fstab 
mount -a

cat /etc/fstab # Check everything is fine
</code></pre><p>Enable OpenRC logging, by setting <code class="purple">rc_logger=&quot;YES&quot;</code> in the file. You will find service boot logs at <code class="purple">/var/log/rc.log</code>.</p>
<pre><code>vi /etc/rc.conf # rc_logger=&quot;YES&quot;
</code></pre><p>Commit all changes and reboot the machine.</p>
<pre><code>lbu ci -d
reboot
</code></pre><p>Check that everything is working as expected. Check that <code class="purple">python3</code> is available as well as the folder <code class="purple">/var/lib/rancher</code>. Now it&#39;s time to install k3s and we&#39;re using Ansible for that.</p>
<h2 id="install-k3s-with-ansible">Install k3s with Ansible</h2>
<p>The changes needed to run Ansible with <code class="purple">k3s-ansible</code> are available in my Pull Request <a class="dim" href="https://github.com/k3s-io/k3s-ansible/pull/107/">k3s-ansible#107</a>. You can copy them into your local Ansible configuration. </p>
<p>Compared to the standard Ubuntu installation, the following steps are different or needed in Alpine. I&#39;ll write the bare shell commands for anyone not using Ansible, although I strongly encourage to use the latter and see my PR for the configuration.</p>
<p>Add the <code class="purple">cgroup</code> mount point: </p>
<pre><code>echo &quot;cgroup /sys/fs/cgroup cgroup defaults 0 0&quot; &gt;&gt; /etc/fstab
</code></pre><p>Add the following lines to <code class="purple">/etc/cgconfig.conf</code> (e.g. <code class="purple">vi /etc/cgconfig.conf</code>):</p>
<pre><code>mount {
  cpuacct = /cgroup/cpuacct;
  memory = /cgroup/memory;
  devices = /cgroup/devices;
  freezer = /cgroup/freezer;
  net_cls = /cgroup/net_cls;
  blkio = /cgroup/blkio;
  cpuset = /cgroup/cpuset;
  cpu = /cgroup/cpu;
}
</code></pre><p>Enable cgroup via boot commandline, by appending the following line to <code class="purple">/media/mmcblk0p1/cmdline.txt</code>. <code class="purple">/media/mmcblk0p1</code> is where the boot files are saved, including the lbu backups and the overlay image (<code class="purple">persist.img</code>). It&#39;s usually at path <code class="purple">/boot</code> :</p>
<pre><code>default_kernel_opts=&quot;...  cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory&quot;
</code></pre><p>Now you can download the k3s binaries. If you want to enable them as services running at boot, you can create the following services at <code class="purple">/etc/init.d/k3s</code> and symlink at <code class="purple">/etc/runlevels/default/k3s</code> to run them as <code class="purple">default</code> runlevel.</p>
<p>K3s server</p>
<pre><code>#!/sbin/openrc-run
name=&quot;k3s server&quot;
command=&quot;/usr/local/bin/k3s&quot;
command_args=&quot;server&quot;
command_background=true
pidfile=&quot;/run/${RC_SVCNAME}.pid&quot;
output_log=&quot;/var/log/k3s.log&quot;
error_log=&quot;/var/log/k3s.err&quot;
</code></pre><p>K3s agent, where <code class="purple">{{ master_ip }}</code> is the IP of the k3s server and <code class="purple">{{ token }}</code> can be found at <code class="purple">/var/lib/rancher/k3s/server/node-token</code> on the server node. It will be available after the first successful run of k3s server.</p>
<pre><code>#!/sbin/openrc-run
name=&quot;k3s agent&quot;
command=&quot;/usr/local/bin/k3s&quot;
command_args=&quot;agent --server https://{{ master_ip }}:6443 --token {{ token }}&quot;
command_background=true
pidfile=&quot;/run/${RC_SVCNAME}.pid&quot;
output_log=&quot;/var/log/k3s.log&quot;
error_log=&quot;/var/log/k3s.err&quot;
</code></pre><p>Check if the changes are working as intended and reboot.</p>
<pre><code>lbu status
lbu ci -d
reboot
</code></pre><p>After the reboot, the services should start and the k3s cluster will be up and running for the first time. Copy the kubeconfig from the server node to laptop.</p>
<pre><code>scp root@192.168.1.1:~/.kube/config ~/.kube/config
</code></pre><p>Still on the laptop shell, set the <code class="purple">KUBECONFIG</code> env variable and check if the cluster is up and running.</p>
<pre><code>export KUBECONFIG=~/.kube/config
kubectl get nodes
</code></pre><p>You should have something like:</p>
<pre><code>NAME     STATUS   ROLES    AGE     VERSION
rasp-1   Ready    master   3m   v1.17.5+k3s1
rasp-3   Ready    &lt;none&gt;   3m   v1.17.5+k3s1
rasp-4   Ready    &lt;none&gt;   3m   v1.17.5+k3s1
rasp-2   Ready    &lt;none&gt;   3m   v1.17.5+k3s1
</code></pre><h2 id="resources">Resources</h2>
<p>The previous commands are the result of my experiments. I&#39;ll link the articles which helped me configure the system.</p>
<ul>
<li><a class="dim" href="https://rancher.com/docs/k3s/latest/en/architecture/">k3s architecture</a> to know where token and passwords are stored</li>
<li><a class="dim" href="https://d-heinrich.medium.com/k3s-bootstrap-on-alpine-linux-c207c85c3f3d">k3s bootstrap on Alpine Linux</a> bare commands to run without Ansible</li>
<li><a class="dim" href="https://wiki.alpinelinux.org/wiki/Alpine_Linux_Init_System">Alpine Linux Init System</a> as quick cheatsheet of OpenRC commands</li>
<li><a class="dim" href="https://wiki.alpinelinux.org/wiki/Alpine_local_backup">Alpine local backup</a> to learn about lbu</li>
<li><a class="dim" href="https://wiki.alpinelinux.org/wiki/Raspberry_Pi">wiki.alpinelinux/Raspberry Pi</a> from which most commands are taken</li>
<li><a class="dim" href="https://github.com/OpenRC/openrc/blob/master/service-script-guide.md">OpenRC Service Script Writing Guide</a></li>
</ul>
<h2 id="conclusions-on-alpine-linux-and-k3s">Conclusions on Alpine Linux and K3s</h2>
<p>The whole process is challenging but the results are worth it.</p>
<p>Alpine Linux uses only ~55MB on my Raspberry Pi 3B+. Now, most resources are used by k3s-server and k3s-agent. K3s-server now takes about 500MB of RAM and I guess it&#39;s because Go prefers to increase the memory consumption instead of running garbage collection cycles. K3s-agent takes approx 128MB of memory.</p>
<p>There&#39;s an ongoing issue <a class="dim" href="https://github.com/k3s-io/k3s/issues/2278">k3s#2278</a> about k3s CPU and memory usage, which should be less considering it&#39;s described as k8s for IoT and Edge. I hope it improves in future.</p>
</div>
        </div>
      </section>
    </article>

    <div class="comments measure-wide center ph2 ph0-l">
  <script>var ISSUE_ID = '43';</script>

  <h3>Comments</h3>

  
    <div class="br2 ba b--lightest-blue bg-washed-blue f6 mb5">
      <div class="flex items-center">
        <div class="fg1 pa3">
          <div>
            <p class="black-70 measure lh-copy mv0">
              This blog is using GitHub Issues as comments. You can post by replying to issue
              <a href="https://github.com/jiayihu/blog/issues/43#new_comment_field" class="link black f5 underline-hover" target="_blank" rel="noopener noreferrer">
                #43
              </a>
            </p>
          </div>
        </div>
        <div class="w5 pa3">
          <a href="https://github.com/jiayihu/blog/issues/43#new_comment_field" class="link no-underline f6 tc db w-100 pv3 bg-animate bg-dark-green hover-bg-dark-blue white br2" target="_blank" rel="noopener noreferrer">
            Post a comment
          </a>
        </div>
      </div>
    </div>
  

  <div class="comments-content"></div>

  <!-- HTML put to avoid uncss removing the CSS classes needed by async comments -->
  <ul class="list pl0 dn">
    <li class="comment flex mt3">
      <div class="comment__author mr2 tc">
        <a href="https://github.com/jiayihu" class="dib h2--half w2--half">
          <img src="https://avatars1.githubusercontent.com/u/10067273?v=4" alt="jiayihu" class="br2 h2--half w2--half dib">
        </a>
      </div>
      <div class="fg1 br2 ba b--moon-gray f6 measure-wide">
        <div class="comment__header bb b--moon-gray bg-black-05 flex items-center silver ph3 pv2">
          <span>
            <a href="https://github.com/jiayihu" class="link underline-hover near-black">
              jiayihu
            </a>
            commented
            <a href="https://github.com/jiayihu/blog/issues/2#issuecomment-394303150" class="link underline-hover silver">
              2 weeks ago
            </a>
          </span>
          <span class="ba b--moon-gray br2 mla f7 fw7 ph2 pv1">Author</span>
        </div>
        <div class="comment__body pa3"></div>
    </div></li>
  </ul>
</div>
 <footer class="pv4 ph3 ph5-ns tc mt4">
  <a class="link dim gray dib h2 w2 br-100 mr3" href="https://twitter.com/jiayi_ghu" title="">
    <svg data-icon="twitter" viewBox="0 0 32 32" style="fill: currentcolor;">
      <title>twitter icon</title>
      <path
        d="M2 4 C6 8 10 12 15 11 A6 6 0 0 1 22 4 A6 6 0 0 1 26 6 A8 8 0 0 0 31 4 A8 8 0 0 1 28 8 A8 8 0 0 0 32 7 A8 8 0 0 1 28 11 A18 18 0 0 1 10 30 A18 18 0 0 1 0 27 A12 12 0 0 0 8 24 A8 8 0 0 1 3 20 A8 8 0 0 0 6 19.5 A8 8 0 0 1 0 12 A8 8 0 0 0 3 13 A8 8 0 0 1 2 4"
      ></path>
    </svg>
  </a>
  <a class="link dim gray dib br-100 h2 w2 mr3" href="https://github.com/jiayihu" title="">
    <svg data-icon="github" viewBox="0 0 32 32" style="fill: currentcolor;">
      <title>github icon</title>
      <path
        d="M0 18 C0 12 3 10 3 9 C2.5 7 2.5 4 3 3 C6 3 9 5 10 6 C12 5 14 5 16 5 C18 5 20 5 22 6 C23 5 26 3 29 3 C29.5 4 29.5 7 29 9 C29 10 32 12 32 18 C32 25 30 30 16 30 C2 30 0 25 0 18 M3 20 C3 24 4 28 16 28 C28 28 29 24 29 20 C29 16 28 14 16 14 C4 14 3 16 3 20 M8 21 A1.5 2.5 0 0 0 13 21 A1.5 2.5 0 0 0 8 21 M24 21 A1.5 2.5 0 0 0 19 21 A1.5 2.5 0 0 0 24 21 z"
      ></path>
    </svg>
  </a>
  <a class="link dim gray dib br-100 h2 w2 mr3" href="https://www.linkedin.com/in/jiayi-hu/" title="LinkedIn">
    <svg
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 16 16"
      fill-rule="evenodd"
      clip-rule="evenodd"
      stroke-linejoin="round"
      stroke-miterlimit="1.414"
    >
      <title>LinkedIn icon</title>
      <path
        d="M13.632 13.635h-2.37V9.922c0-.886-.018-2.025-1.234-2.025-1.235 0-1.424.964-1.424 1.96v3.778h-2.37V6H8.51V7.04h.03c.318-.6 1.092-1.233 2.247-1.233 2.4 0 2.845 1.58 2.845 3.637v4.188zM3.558 4.955c-.762 0-1.376-.617-1.376-1.377 0-.758.614-1.375 1.376-1.375.76 0 1.376.617 1.376 1.375 0 .76-.617 1.377-1.376 1.377zm1.188 8.68H2.37V6h2.376v7.635zM14.816 0H1.18C.528 0 0 .516 0 1.153v13.694C0 15.484.528 16 1.18 16h13.635c.652 0 1.185-.516 1.185-1.153V1.153C16 .516 15.467 0 14.815 0z"
        fill-rule="nonzero"
      />
    </svg>
  </a>
  <small class="mt4 f6 db tc">Â© 2020. All Rights Reserved</small>
</footer>

<script src="https://polyfill.io/v3/polyfill.min.js?features=default%2Cfetch"></script>
<script src="/js/main.js"></script>
<script src="/js/prism.js"></script>

<script>
  (function (i, s, o, g, r, a, m) {
    i["GoogleAnalyticsObject"] = r;
    (i[r] =
      i[r] ||
      function () {
        (i[r].q = i[r].q || []).push(arguments);
      }),
      (i[r].l = 1 * new Date());
    (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m);
  })(
    window,
    document,
    "script",
    "https://www.google-analytics.com/analytics.js",
    "ga"
  );

  ga("create", "UA-103053006-1", "auto");
  ga("send", "pageview");
</script>


    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </body>
</html>
