<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="google-site-verification" content="6DIBzCM2sFIHFrOECCKoODFkMjWkvkmxMqJD0EFb7xU">
<style>
  html{line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,header,nav,section{display:block}h1{font-size:2em;margin:.67em 0}a{background-color:transparent;-webkit-text-decoration-skip:objects}svg:not(:root){overflow:hidden}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}.border-box,a,article,body,div,h1,header,html,p,section{-webkit-box-sizing:border-box;box-sizing:border-box}.cover{background-size:cover!important}.db{display:block}.dib{display:inline-block}.dt{display:table}.dtc{display:table-cell}@media screen and (min-width:60em){.dt-l{display:table}.dtc-l{display:table-cell}}.sans-serif{font-family:-apple-system,BlinkMacSystemFont,avenir next,avenir,helvetica neue,helvetica,ubuntu,roboto,noto,segoe ui,arial,sans-serif}.serif{font-family:Merriweather,georgia,times,serif}.i{font-style:italic}.fs-normal{font-style:normal}.vh-75{height:75vh}.tracked{letter-spacing:.1em}.lh-title{line-height:1.25}.lh-copy{line-height:1.5}.link{color:#199190;text-decoration:none}.w-100{width:100%}@media screen and (min-width:60em){.w-25-l{width:25%}.w-75-l{width:75%}}.relative{position:relative}.dark-gray{color:#333}.mid-gray{color:#555}.bg-washed-yellow{background-color:#f1e7ce}.pa3{padding:16px;padding:1rem}.pv5{padding-top:64px;padding-top:4rem;padding-bottom:64px;padding-bottom:4rem}.ph0{padding-left:0;padding-right:0}.ph2{padding-left:8px;padding-left:.5rem;padding-right:8px;padding-right:.5rem}.ph3{padding-left:16px;padding-left:1rem;padding-right:16px;padding-right:1rem}.mr3{margin-right:16px;margin-right:1rem}.mb2{margin-bottom:8px;margin-bottom:.5rem}.mh0{margin-left:0;margin-right:0}@media screen and (min-width:60em){.ph5-l{padding-left:4rem;padding-right:4rem}.mr4-l{margin-right:2rem}.mb0-l{margin-bottom:0}}.tc{text-align:center}@media screen and (min-width:60em){.tl-l{text-align:left}.tr-l{text-align:right}}.ttu{text-transform:uppercase}.f1{font-size:48px;font-size:3rem}.f3{font-size:24px;font-size:1.5rem}.f4{font-size:20px;font-size:1.25rem}.f5{font-size:16px;font-size:1rem}.f6{font-size:14px;font-size:.875rem}@media screen and (min-width:60em){.f-headline-l{font-size:4rem}.f5-l{font-size:1rem}}.measure{max-width:30em}.center{margin-right:auto;margin-left:auto}.v-mid{vertical-align:middle}a{color:inherit}h1{font-weight:400}.dark-gold{color:#5a440d}
</style>
<link rel="preload" href="/css/main.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="/css/main.css"></noscript>
<link rel="preload" href="/css/prism.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="/css/prism.css"></noscript>
<link href="https://fonts.googleapis.com/css?family=Merriweather:400,400i,700" rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link href="https://fonts.googleapis.com/css?family=Merriweather:400,400i,700" rel="stylesheet"></noscript>
<script>!function(n){"use strict";n.loadCSS||(n.loadCSS=function(){});var o=loadCSS.relpreload={};if(o.support=function(){var e;try{e=n.document.createElement("link").relList.supports("preload")}catch(t){e=!1}return function(){return e}}(),o.bindMediaToggle=function(t){var e=t.media||"all";function a(){t.addEventListener?t.removeEventListener("load",a):t.attachEvent&&t.detachEvent("onload",a),t.setAttribute("onload",null),t.media=e}t.addEventListener?t.addEventListener("load",a):t.attachEvent&&t.attachEvent("onload",a),setTimeout(function(){t.rel="stylesheet",t.media="only x"}),setTimeout(a,3e3)},o.poly=function(){if(!o.support())for(var t=n.document.getElementsByTagName("link"),e=0;e<t.length;e++){var a=t[e];"preload"!==a.rel||"style"!==a.getAttribute("as")||a.getAttribute("data-loadcss")||(a.setAttribute("data-loadcss",!0),o.bindMediaToggle(a))}},!o.support()){o.poly();var t=n.setInterval(o.poly,500);n.addEventListener?n.addEventListener("load",function(){o.poly(),n.clearInterval(t)}):n.attachEvent&&n.attachEvent("onload",function(){o.poly(),n.clearInterval(t)})}"undefined"!=typeof exports?exports.loadCSS=loadCSS:n.loadCSS=loadCSS}("undefined"!=typeof global?global:this);</script>

<!-- Favicons -->
<link rel="apple-touch-icon" sizes="180x180" href="/images/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/images/icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/images/icons/favicon-16x16.png">
<link rel="mask-icon" href="/images/icons/safari-pinned-tab.svg" color="#5bbad5">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Jiayi's Chronicles">

<meta name="msapplication-TileColor" content="#ffffff">
<meta name="theme-color" content="#ffffff">

<link rel="manifest" href="/manifest.json">

    <title>Testing Observables in RxJS6 | Jiayi's Chronicles</title>
    <!-- Search Engine -->
<meta name="description" content="Introduction to RxJS marble testing, TestScheduler and how to improve Observable testing experience">
<!-- Schema.org for Google -->
<meta itemprop="name" content="Testing Observables in RxJS6">
<meta itemprop="description" content="Introduction to RxJS marble testing, TestScheduler and how to improve Observable testing experience">
<!-- Twitter -->
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Testing Observables in RxJS6">
<meta name="twitter:description" content="Introduction to RxJS marble testing, TestScheduler and how to improve Observable testing experience">
<meta name="twitter:site" content="@jiayi_ghu">
<meta name="twitter:image:src" content="http://blog.jiayihu.net/images/testing-rxjs6/cover.jpg">
<!-- Open Graph general (Facebook, Pinterest & Google+) -->
<meta name="og:title" content="Testing Observables in RxJS6">
<meta name="og:description" content="Introduction to RxJS marble testing, TestScheduler and how to improve Observable testing experience">
<meta name="og:image" content="http://blog.jiayihu.net/images/testing-rxjs6/cover.jpg">
<meta name="og:url" content="http://blog.jiayihu.net/testing-observables-in-rxjs6">
<meta name="og:site_name" content="Jiayi's Chronicles">
<meta name="og:type" content="website">

  </head>

  <body class="page--article dark-grey lh-copy sans-serif">
    <nav class="db dt-l w-100 border-box pa3 ph5-l">
  <a class="db dtc-l v-mid mid-gray link serif underline-hover w-100 w-25-l tc tl-l mb2 mb0-l f3" href="/" title="Home">
    Jiayi's Chronicles
  </a>
  <div class="db dtc-l v-mid w-100 w-75-l tc tr-l">
    <a class="link underline-hover dark-gray f6 f5-l dib mr3 mr4-l" href="/" title="Home">Home</a>
    <a class="link underline-hover dark-gray f6 f5-l dib mr3 mr4-l" href="/about" title="About me">About me</a>
  </div>
</nav>


    <article>
      <header class="vh-75 dt w-100 tc bg-washed-yellow cover">
        <div class="article__header dark-gold dtc serif v-mid">
          <h1 class="article__title f1 f-headline-l i lh-title ph3">
            Testing Observables in RxJS6
          </h1>
          <div class="ph0 mh0 measure f4 lh-copy center">
            <p class="article__subtitle">
              Introduction to RxJS marble testing, TestScheduler and how to improve Observable testing experience
            </p>
            <p class="article-meta f6 ttu tracked fs-normal">
              Jiayi Hu - Jun 18th 2018
            </p>
          </div>
        </div>
      </header>
      <section class="article-main f5 pv5 lh-copy ph2 relative">
        <a href="https://github.com/jiayihu/blog/tree/master/src/articles/testing-rxjs6.md" class="color-inherit f6 no-underline underline-hover glow absolute top-1 right-1" target="_blank" rel="noopener noreferrer">
          <span class="dib w1">
            <svg
              viewBox="0 0 256 250"
              version="1.1"
              xmlns="http://www.w3.org/2000/svg"
              xmlns:xlink="http://www.w3.org/1999/xlink"
              preserveAspectRatio="xMidYMid"
            >
              <g>
                <path
                  d="M128.00106,0 C57.3172926,0 0,57.3066942 0,128.00106 C0,184.555281 36.6761997,232.535542 87.534937,249.460899 C93.9320223,250.645779 96.280588,246.684165 96.280588,243.303333 C96.280588,240.251045 96.1618878,230.167899 96.106777,219.472176 C60.4967585,227.215235 52.9826207,204.369712 52.9826207,204.369712 C47.1599584,189.574598 38.770408,185.640538 38.770408,185.640538 C27.1568785,177.696113 39.6458206,177.859325 39.6458206,177.859325 C52.4993419,178.762293 59.267365,191.04987 59.267365,191.04987 C70.6837675,210.618423 89.2115753,204.961093 96.5158685,201.690482 C97.6647155,193.417512 100.981959,187.77078 104.642583,184.574357 C76.211799,181.33766 46.324819,170.362144 46.324819,121.315702 C46.324819,107.340889 51.3250588,95.9223682 59.5132437,86.9583937 C58.1842268,83.7344152 53.8029229,70.715562 60.7532354,53.0843636 C60.7532354,53.0843636 71.5019501,49.6441813 95.9626412,66.2049595 C106.172967,63.368876 117.123047,61.9465949 128.00106,61.8978432 C138.879073,61.9465949 149.837632,63.368876 160.067033,66.2049595 C184.49805,49.6441813 195.231926,53.0843636 195.231926,53.0843636 C202.199197,70.715562 197.815773,83.7344152 196.486756,86.9583937 C204.694018,95.9223682 209.660343,107.340889 209.660343,121.315702 C209.660343,170.478725 179.716133,181.303747 151.213281,184.472614 C155.80443,188.444828 159.895342,196.234518 159.895342,208.176593 C159.895342,225.303317 159.746968,239.087361 159.746968,243.303333 C159.746968,246.709601 162.05102,250.70089 168.53925,249.443941 C219.370432,232.499507 256,184.536204 256,128.00106 C256,57.3066942 198.691187,0 128.00106,0 Z M47.9405593,182.340212 C47.6586465,182.976105 46.6581745,183.166873 45.7467277,182.730227 C44.8183235,182.312656 44.2968914,181.445722 44.5978808,180.80771 C44.8734344,180.152739 45.876026,179.97045 46.8023103,180.409216 C47.7328342,180.826786 48.2627451,181.702199 47.9405593,182.340212 Z M54.2367892,187.958254 C53.6263318,188.524199 52.4329723,188.261363 51.6232682,187.366874 C50.7860088,186.474504 50.6291553,185.281144 51.2480912,184.70672 C51.8776254,184.140775 53.0349512,184.405731 53.8743302,185.298101 C54.7115892,186.201069 54.8748019,187.38595 54.2367892,187.958254 Z M58.5562413,195.146347 C57.7719732,195.691096 56.4895886,195.180261 55.6968417,194.042013 C54.9125733,192.903764 54.9125733,191.538713 55.713799,190.991845 C56.5086651,190.444977 57.7719732,190.936735 58.5753181,192.066505 C59.3574669,193.22383 59.3574669,194.58888 58.5562413,195.146347 Z M65.8613592,203.471174 C65.1597571,204.244846 63.6654083,204.03712 62.5716717,202.981538 C61.4524999,201.94927 61.1409122,200.484596 61.8446341,199.710926 C62.5547146,198.935137 64.0575422,199.15346 65.1597571,200.200564 C66.2704506,201.230712 66.6095936,202.705984 65.8613592,203.471174 Z M75.3025151,206.281542 C74.9930474,207.284134 73.553809,207.739857 72.1039724,207.313809 C70.6562556,206.875043 69.7087748,205.700761 70.0012857,204.687571 C70.302275,203.678621 71.7478721,203.20382 73.2083069,203.659543 C74.6539041,204.09619 75.6035048,205.261994 75.3025151,206.281542 Z M86.046947,207.473627 C86.0829806,208.529209 84.8535871,209.404622 83.3316829,209.4237 C81.8013,209.457614 80.563428,208.603398 80.5464708,207.564772 C80.5464708,206.498591 81.7483088,205.631657 83.2786917,205.606221 C84.8005962,205.576546 86.046947,206.424403 86.046947,207.473627 Z M96.6021471,207.069023 C96.7844366,208.099171 95.7267341,209.156872 94.215428,209.438785 C92.7295577,209.710099 91.3539086,209.074206 91.1652603,208.052538 C90.9808515,206.996955 92.0576306,205.939253 93.5413813,205.66582 C95.054807,205.402984 96.4092596,206.021919 96.6021471,207.069023 Z"
                  fill="#161614"
                ></path>
              </g>
            </svg>
          </span>
          Edit on GitHub
        </a>

        <div class="center measure-wide">
          <div class="article-content"><p>With the release of RxJS6 there has been a great improvement of Observables testing and this article will guide you in the path of using RxJS marble syntax with the latest testing APIs.<br>In the second part, we&#39;ll cover instead how to improve the testing developer-experience, especially if you&#39;re not using Karma/Jasmine and you write your tests with something else like Jest, in my case, or Mocha/Tape/AVA.</p>
<h2 id="marble-syntax">Marble syntax</h2>
<p><strong>Marble diagrams</strong> are visual representations of an Observable flow to help you understand the flow of values and how an operator works. You see them everywhere in the RxJS documentation and they are very useful to convey the functioning of Observables.</p>
<p>
    <figure>
      <a href="/images/testing-rxjs6/map.png" target="_blank" rel="noopener noreferrer">
        <img class="lozad" data-src="/images/testing-rxjs6/map.png" alt="Marble Diagram of .map operator">
      </a>
      <figcaption class="f6 i tr mt1">Marble Diagram of .map operator</figcaption>
    </figure>
  </p>
<p>If you&#39;re not familiar with marble diagram, you can <a class="dark-green dim" href="https://medium.com/@jshvarts/read-marble-diagrams-like-a-pro-3d72934d3ef5">read more about them here</a>.</p>
<p>So what about marble syntax? Well, put simply, it&#39;s just an ASCII description of a marble diagram which can be used when writing about Observables.</p>
<p>The previous marble diagram of <code class="purple">.map</code> could be written as:</p>
<pre><code>-1 ---2 ---3 ---|
  .map(x =&gt; x * 2)
-2 ---4 ---6 ---|
</code></pre><p>Every alphanumeric string is considered as an emitted value and hyphens <code class="purple">&#39;-&#39;</code> are units of time. To be precise: </p>
<ul>
<li><code class="purple">&#39; &#39;</code> whitespace: horizontal whitespace is ignored and can be used to help vertically align multiple marble diagrams like we did to align the first stream of values</li>
<li><code class="purple">&#39;-&#39;</code> frame: a unit of time</li>
<li><code class="purple">&#39;|&#39;</code> complete: the successful completion of an observable</li>
<li><code class="purple">&#39;#&#39;</code> error: an error terminating the observable</li>
<li><code class="purple">[a-z0-9]</code> e.g. &#39;a&#39; any alphanumeric character: represents a value being emitted</li>
<li><code class="purple">()</code> sync groupings: When multiple events need to be in the same frame synchronously, parentheses are used to group those events</li>
</ul>
<p>Let&#39;s take a step further: now the idea is using marble syntax to test Observables! Since streams are collections of async values, testing by subscribing and using classic assertions would be very difficult, counter-intuitive and unreadable. By instead taking advantage of marble syntax, we can write visually explicit tests about the flow of emitted and expected values from an Observable.</p>
<h2 id="testing-observables">Testing Observables</h2>
<p>In the next examples, we&#39;ll use <a class="dark-green dim" href="https://github.com/jiayihu/rx-polling">rx-polling</a> as use case for writing Observable tests. <code class="purple">rx-polling</code> is a library which subscribes to a <code class="purple">source$</code> Observable infinitely every N seconds and can be used with any Observable, although a polling service is usually a network request for updates (a poor man&#39;s WebSocket).</p>
<p>Let&#39;s see a base test for the library:</p>
<pre><code class="lang-typescript">test(&#39;It should poll the source$ every interval&#39;, () =&gt; {
  scheduler.run(helpers =&gt; {
    const source$ = of(1); // Observable.of(1)
    const polling$ = polling(source$, { interval: 2 }).pipe(take(3));
    const expected = &#39;1-1-(1|)&#39;;

    helpers.expectObservable(polling$).toBe(expected, { 1: 1 });
  });
});
</code></pre>
<p>The <code class="purple">source$</code> Observable is just a stream of just 1, which can be rapresented as <code class="purple">(1|)</code>. Note that the use of <code class="purple">()</code> is important because the stream emits 1 and it completes immediately on frame zero, whereas <code class="purple">1|</code> would mean that it emits 1 at frame zero and it completes at first one.</p>
<p>A polling service would then take this Observable and repeat the subscription periodically. In this case, we are asking for a subscription every 2ms. 2ms would be too frequent for any real usage and usually, you would pass values like 1000/3000ms indeed, but here we are within a unit test and we have a different rapresentation of time. First, we don&#39;t want to wait real time like 3 seconds and, second, <strong>a frame <code class="purple">&#39;-&#39;</code> equals 1ms when unit testing Observables</strong>. The marble syntax of the polling Observable would be then:</p>
<pre><code>(1|)                                // source$
  polling(source$, { interval: 2 })
1-1-1-1-1-1-1-1-                    // and so on infinitely
  .pipe(take(3))
1-1-(1|)
</code></pre><p>As you can see, the final marble stream is exactly the one we declared as <code class="purple">expected</code> within the test. Now, what&#39;s left is making an assertion about the result. The line</p>
<pre><code class="lang-typescript">helpers.expectObservable(polling$).toBe(expected, { 1: 1 });
</code></pre>
<p>serves this purpose. <code class="purple">expectObservable</code> takes an Observable as input and checks if the subscription matches the expected stream described by the marble syntax. We pass also a second parameter to <code class="purple">.toBe</code> because alphanumeric characters are interpreted as an emission of strings by default. By giving <code class="purple">{ 1: 1 }</code> we are informing rxjs that the character &#39;1&#39; corresponds to the literal number 1.</p>
<p>But where do <code class="purple">helpers</code> come from? And what is the wrapping <code class="purple">scheduler.run</code>? Okay, let&#39;s talk about schedulers 😱</p>
<h2 id="testscheduler">TestScheduler</h2>
<p>In computing, a <strong>scheduler</strong> is a software which schedules/organizes a series of activities in a range of time. They are extremely important in different areas of Computer Science, like the process scheduler of the OS.</p>
<p>In RxJS, a <code class="purple">Scheduler</code> (the class) is used internally by the Observables to know when to start the execution and emit values. Especially within tests, they can be used to change the &quot;meaning of time&quot;, by making the Observables execute synchronously instead of asynchronously, without actually waiting time. We could, for example, decide that 500ms in real-world is just 50m or even 5 ticks of Node event loop.</p>
<p>By default, Observables use <code class="purple">AsyncScheduler</code> which is based on <code class="purple">setInterval</code> for timing, but we can replace it with <code class="purple">TestScheduler</code> in our tests. Put simply, the <code class="purple">TestScheduler</code> answers the question:</p>
<ul>
<li>&quot;What a time frame &#39;-&#39; means actually?&quot;</li>
<li>&quot;1 <strong>virtual</strong> millisecond&quot;.</li>
</ul>
<p>Let&#39;s see a more complete version of the previous test and note how everything is imported from <code class="purple">rxjs</code> without further libraries:</p>
<pre><code class="lang-typescript">import { Observable, of, timer, throwError, Observer } from &#39;rxjs&#39;;
import { take, map } from &#39;rxjs/operators&#39;;
import { TestScheduler } from &#39;rxjs/testing&#39;;
import polling from &#39;rx-polling&#39;;

/**
 * Simple deep equal assertion.
 */
function assertDeepEqual(actual, expected) {
  expect(actual).toEqual(expected);
}


describe(&#39;Basic behaviour&#39;, function() {
  let scheduler: TestScheduler;

  beforeEach(() =&gt; {
    scheduler = new TestScheduler(assertDeepEqual);
  });

  test(&#39;It should poll the source$ every interval&#39;, () =&gt; {
    scheduler.run(helpers =&gt; {
      const source$ = of(1);
      const polling$ = polling(source$, { interval: 2 }).pipe(take(3));
      const expected = &#39;1-1-(1|)&#39;;

      helpers.expectObservable(polling$).toBe(expected, { 1: 1 });
    });
  });
});
</code></pre>
<p>Woah! So much more code! But actually, it just shows how to create a <code class="purple">TestScheduler</code>, by passing a function which makes an assertion about deep equality between the actual Observable stream and the expected one. We&#39;ll go more deeply about it in the second part of the article. Then the instance of <code class="purple">TestScheduler</code> can be used as follows:</p>
<pre><code class="lang-typescript">scheduler.run(helpers =&gt; {
  // ... some Observable testing
});
</code></pre>
<p>This code is similar to <code class="purple">this.zone.run(...)</code> of Angular NgZone, which executes all you async code inside a &quot;zone&quot; which can detect changes to your application. Likewise <code class="purple">scheduler.run()</code> executes your Observables within a special &quot;zone&quot; where the time is controlled by <code class="purple">TestScheduler</code>.</p>
<p>The first parameter <code class="purple">helpers</code> is instead passed by the scheduler and it has different methods:</p>
<ul>
<li><code class="purple">cold(marbleDiagram: string, values?: object)</code> - creates a &quot;cold&quot; observable by using a marble syntax. This method is useful if you cannot create Observables using the more common static methods <code class="purple">of/fromEvent/timer/interval</code> etc.</li>
<li><code class="purple">expectObservable(actual: Observable&lt;T&gt;).toBe(marbleDiagram: string, values?: object)</code> - schedules an assertion</li>
</ul>
<p>Other methods are listed in the <a class="dark-green dim" href="https://github.com/ReactiveX/rxjs/blob/master/doc/marble-testing.md#api">TestScheduler API documentation</a>, including the ones for dealing with &quot;hot&quot; observables. If you don&#39;t know the difference between hot &amp; cold Observables, you can read more about the topic in <a class="dark-green dim" href="https://medium.com/@benlesh/hot-vs-cold-observables-f8094ed53339">&quot;Hot vs Cold Observables&quot;</a>. For the sake of simplicity, we can say the cold observables are the most common ones, like <code class="purple">Observable.of(1)</code>, whereas those involved in <code class="purple">Subjects</code> are hot, but they&#39;re not used in this guide.</p>
<p>The following example tests about error recovery in <code class="purple">rx-polling</code> and <code class="purple">helpers.cold</code> is used to create an Observable which emits 2 values and then throws.</p>
<pre><code class="lang-typescript">test(&#39;It should retry on error&#39;, () =&gt; {
  scheduler.run(helpers =&gt; {
    const source$ = helpers.cold(&#39;-1-2-#&#39;);
    const expected = &#39;-1-2- ------ -1-2- ------ -(1|)&#39;;
    const polling$ = polling(source$, { interval: 6 }).pipe(take(5));

    helpers.expectObservable(polling$).toBe(expected);
  });
});
</code></pre>
<p>The expected result, in the previous snippet, waits for 6 frames before retrying. The same marble can be written more concisely using the new <strong>time progression syntax</strong>, by expressing it as <code class="purple">6ms</code> surrounded by a space to avoid ambiguity with a series of emitted values:</p>
<pre><code class="lang-typescript">const expected = &#39;-1-2- 6ms -1-2- 6ms -(1|)&#39;;
</code></pre>
<p>And that&#39;s it! You should be able to finally test Observables in your application! This is just an introduction but we&#39;ve covered a lot of concepts, so have a rest before reading the rest of the article and absolutely give it a try!</p>
<p>More information about <code class="purple">TestScheduler</code> and testing can be found in the official doc for <a class="dark-green dim" href="https://github.com/ReactiveX/rxjs/blob/master/doc/marble-testing">Marble testing</a>.</p>
<hr>
<h2 id="second-part-improving-testing-experience">Second part: improving testing experience</h2>
<h3 id="testmessage-and-notification">TestMessage and Notification</h3>
<p>Did you spend some time trying testing your Observables? When you start writing RxJS tests using marbles, you&#39;ll start to see the following diff when tests fail:</p>
<pre><code class="lang-diff">    Object {
-     &quot;frame&quot;: 11,
+     &quot;frame&quot;: 9,
      &quot;notification&quot;: Notification {
        &quot;error&quot;: undefined, 
        &quot;hasValue&quot;: true,
        &quot;kind&quot;: &quot;N&quot;, // N -&gt; value (next), E -&gt; error, C -&gt; completion
        &quot;value&quot;: &quot;1&quot;,
      },
    }
</code></pre>
<p>The object is an instance of <code class="purple">TestMessage</code> describing a frame of the Observable stream. Every frame in the marble syntax is interpreted as a <code class="purple">TestMessage</code> and, when the received stream doesn&#39;t match the expected one, the test runner will throw a diff like the previous one.</p>
<p>Basically, it states &quot;You expected 1 at frame 11, but actually the Observable emitted it at frame 9&quot;. Converted back in marble syntax would be:</p>
<pre><code class="lang-diff">// For simplicity we use &#39;-&#39; for the frames preceding the one thrown
- ----------1
+ --------1
</code></pre>
<p>When you define your tests using marble syntax, the latter is trasformed into an array of <code class="purple">TestMessage</code> followed by a comparison between the received Observable <code class="purple">TestMessage[]</code> and the expected one. Unfortunately <code class="purple">TestMessage[]</code> is not converted back to marbles, so usually, the test runner diff can be daunting to read.</p>
<h2 id="marble-matcher">Marble matcher</h2>
<p>A <strong>&quot;matcher&quot;</strong> is a test runner function used to test values in different ways. Jasmine/Jest have built-in matchers for primitive values, objects, arrays etc. with different visual outputs when the test fails.</p>
<p>We can then define our custom matcher for <code class="purple">TestMessage[]</code>, which transforms them back into marbles. Fortunately, if you use Jasmine, you&#39;re already covered with <a class="dark-green dim" href="https://github.com/synapse-wireless-labs/jasmine-marbles">jasmine-marbles</a>, whereas for other test runners you can use <a class="dark-green dim" href="https://github.com/cartant/rxjs-marbles">rxjs-marbles</a>.</p>
<p>I have defined my own custom matcher a long time ago, when I first published <code class="purple">rx-polling</code> a year ago, but you can obtain a similar result using the former libraries:</p>
<p>
    <figure>
      <a href="/images/testing-rxjs6/marbles-diff.png" target="_blank" rel="noopener noreferrer">
        <img class="lozad" data-src="/images/testing-rxjs6/marbles-diff.png" alt="RxJS Marble matcher">
      </a>
      <figcaption class="f6 i tr mt1">RxJS Marble matcher</figcaption>
    </figure>
  </p>
<p>As you can see it&#39;s much prettier than before!</p>
<h2 id="conclusion">Conclusion</h2>
<p>It was a long journey, we have covered marble syntax and how to use it for Observable testing along with <code class="purple">TestScheduler</code>. We&#39;ve also seen how marble syntax is converted to <code class="purple">TestMessage[]</code> by RxJS and how a test matcher can improve our testing experience.</p>
<p>I hope this guide cleared some misteries around RxJS testing and will make our application more solid! More examples of Observable tests can be found in the file <a class="dark-green dim" href="https://github.com/jiayihu/rx-polling/blob/master/test/index.spec.ts">rx-polling/test/index.spec.ts</a>.</p>
</div>
        </div>
      </section>
    </article>

    <div class="comments measure-wide center ph2 ph0-l">
  <script>var ISSUE_ID = '30';</script>

  <h3>Comments</h3>

  
    <div class="br2 ba b--lightest-blue bg-washed-blue f6 mb5">
      <div class="flex items-center">
        <div class="fg1 pa3">
          <div>
            <p class="black-70 measure lh-copy mv0">
              This blog is using GitHub Issues as comments. You can post by replying to issue
              <a href="https://github.com/jiayihu/blog/issues/30#new_comment_field" class="link black f5 underline-hover" target="_blank" rel="noopener noreferrer">
                #30
              </a>
            </p>
          </div>
        </div>
        <div class="w5 pa3">
          <a href="https://github.com/jiayihu/blog/issues/30#new_comment_field" class="no-underline f6 tc db w-100 pv3 bg-animate bg-dark-green hover-bg-dark-blue white br2" target="_blank" rel="noopener noreferrer">
            Post a comment
          </a>
        </div>
      </div>
    </div>
  

  <div class="comments-content"></div>

  <!-- HTML put to avoid uncss removing the CSS classes needed by async comments -->
  <ul class="list pl0 dn">
    <li class="comment flex mt3">
      <div class="comment__author mr2 tc">
        <a href="https://github.com/jiayihu" class="dib h2--half w2--half">
          <img src="https://avatars1.githubusercontent.com/u/10067273?v=4" alt="jiayihu" class="br2 h2--half w2--half dib">
        </a>
      </div>
      <div class="fg1 br2 ba b--moon-gray f6">
        <div class="comment__header bb b--moon-gray bg-black-05 flex items-center silver ph3 pv2">
          <span>
            <a href="https://github.com/jiayihu" class="link underline-hover near-black">
              jiayihu
            </a>
            commented
            <a href="https://github.com/jiayihu/blog/issues/2#issuecomment-394303150" class="link underline-hover silver">
              2 weeks ago
            </a>
          </span>
          <span class="ba b--moon-gray br2 mla f7 fw7 ph2 pv1">Author</span>
        </div>
        <div class="comment__body pa3"></div>
    </div></li>
  </ul>
</div>
 <footer class="pv4 ph3 ph5-ns tc mt4">
  <a class="link dim gray dib h2 w2 br-100 mr3" href="https://twitter.com/jiayi_ghu" title="">
    <svg data-icon="twitter" viewBox="0 0 32 32" style="fill: currentcolor;">
      <title>twitter icon</title>
      <path
        d="M2 4 C6 8 10 12 15 11 A6 6 0 0 1 22 4 A6 6 0 0 1 26 6 A8 8 0 0 0 31 4 A8 8 0 0 1 28 8 A8 8 0 0 0 32 7 A8 8 0 0 1 28 11 A18 18 0 0 1 10 30 A18 18 0 0 1 0 27 A12 12 0 0 0 8 24 A8 8 0 0 1 3 20 A8 8 0 0 0 6 19.5 A8 8 0 0 1 0 12 A8 8 0 0 0 3 13 A8 8 0 0 1 2 4"
      ></path>
    </svg>
  </a>
  <a class="link dim gray dib br-100 h2 w2 mr3" href="https://github.com/jiayihu" title="">
    <svg data-icon="github" viewBox="0 0 32 32" style="fill: currentcolor;">
      <title>github icon</title>
      <path
        d="M0 18 C0 12 3 10 3 9 C2.5 7 2.5 4 3 3 C6 3 9 5 10 6 C12 5 14 5 16 5 C18 5 20 5 22 6 C23 5 26 3 29 3 C29.5 4 29.5 7 29 9 C29 10 32 12 32 18 C32 25 30 30 16 30 C2 30 0 25 0 18 M3 20 C3 24 4 28 16 28 C28 28 29 24 29 20 C29 16 28 14 16 14 C4 14 3 16 3 20 M8 21 A1.5 2.5 0 0 0 13 21 A1.5 2.5 0 0 0 8 21 M24 21 A1.5 2.5 0 0 0 19 21 A1.5 2.5 0 0 0 24 21 z"
      ></path>
    </svg>
  </a>
  <a class="link dim gray dib br-100 h2 w2 mr3" href="https://www.linkedin.com/in/jiayi-hu/" title="LinkedIn">
    <svg
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 16 16"
      fill-rule="evenodd"
      clip-rule="evenodd"
      stroke-linejoin="round"
      stroke-miterlimit="1.414"
    >
      <title>LinkedIn icon</title>
      <path
        d="M13.632 13.635h-2.37V9.922c0-.886-.018-2.025-1.234-2.025-1.235 0-1.424.964-1.424 1.96v3.778h-2.37V6H8.51V7.04h.03c.318-.6 1.092-1.233 2.247-1.233 2.4 0 2.845 1.58 2.845 3.637v4.188zM3.558 4.955c-.762 0-1.376-.617-1.376-1.377 0-.758.614-1.375 1.376-1.375.76 0 1.376.617 1.376 1.375 0 .76-.617 1.377-1.376 1.377zm1.188 8.68H2.37V6h2.376v7.635zM14.816 0H1.18C.528 0 0 .516 0 1.153v13.694C0 15.484.528 16 1.18 16h13.635c.652 0 1.185-.516 1.185-1.153V1.153C16 .516 15.467 0 14.815 0z"
        fill-rule="nonzero"
      />
    </svg>
  </a>
  <small class="mt4 f6 db tc">© 2018. All Rights Reserved</small>
</footer>

<script src="https://polyfill.io/v3/polyfill.min.js?features=default%2Cfetch"></script>
<script src="/js/main.js"></script>
<script src="/js/prism.js"></script>

<script>
  (function (i, s, o, g, r, a, m) {
    i["GoogleAnalyticsObject"] = r;
    (i[r] =
      i[r] ||
      function () {
        (i[r].q = i[r].q || []).push(arguments);
      }),
      (i[r].l = 1 * new Date());
    (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m);
  })(
    window,
    document,
    "script",
    "https://www.google-analytics.com/analytics.js",
    "ga"
  );

  ga("create", "UA-103053006-1", "auto");
  ga("send", "pageview");
</script>

  </body>
</html>
