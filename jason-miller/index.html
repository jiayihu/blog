<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><!-- Favicons --><link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png"><link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#5bbad5"><meta name="generator" content="Astro v4.3.2"><!-- Canonical URL --><link rel="canonical" href="https://blog.jiayihu.net/jason-miller/"><!-- Primary Meta Tags --><title>What I&#39;ve learnt reading Jason Miller&#39;s source code</title><meta name="title" content="What I've learnt reading Jason Miller's source code"><meta name="description" content="A tour of useful JavaScript tricks from his minimal open-source projects"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://blog.jiayihu.net/jason-miller/"><meta property="og:title" content="What I've learnt reading Jason Miller's source code"><meta property="og:description" content="A tour of useful JavaScript tricks from his minimal open-source projects"><meta property="og:image" content="https://blog.jiayihu.net/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://blog.jiayihu.net/jason-miller/"><meta property="twitter:title" content="What I've learnt reading Jason Miller's source code"><meta property="twitter:description" content="A tour of useful JavaScript tricks from his minimal open-source projects"><meta property="twitter:image" content="https://blog.jiayihu.net/blog-placeholder-1.jpg"><meta name="google-site-verification" content="6DIBzCM2sFIHFrOECCKoODFkMjWkvkmxMqJD0EFb7xU"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="apple-mobile-web-app-title" content="Jiayi's Chronicles"><meta name="msapplication-TileColor" content="#ffffff"><meta name="theme-color" content="#ffffff"><style>:root{--accent: #a00;--accent-dark: rgb(110, 1, 1);--black: 15, 18, 25;--sand: 255, 252, 250;--dark-gold: 90, 68, 13;--purple: 111, 66, 193;--gray: 96, 115, 159;--gray-light: 229, 233, 240;--gray-dark: 34, 41, 57;--gray-gradient: rgba(var(--sand), 100%), #fff;--box-shadow: 0 2px 6px rgba(var(--gray), 25%), 0 8px 24px rgba(var(--gray), 33%), 0 16px 32px rgba(var(--gray), 33%)}body{font-family:-apple-system,BlinkMacSystemFont,avenir next,avenir,helvetica neue,helvetica,ubuntu,roboto,noto,segoe ui,arial,sans-serif;margin:0;padding:0;text-align:left;background:linear-gradient(var(--gray-gradient)) no-repeat;background-size:100% 600px;word-wrap:break-word;overflow-wrap:break-word;color:rgb(var(--gray-dark));font-size:16px;line-height:1.7}main{width:720px;max-width:calc(100% - 2em);margin:auto;padding:3em 1em}h1,h2,h3,h4,h5,h6{font-family:Latin Modern,Georgia,Cambria,Times New Roman,Times,serif;font-weight:400;margin:0 0 .5rem;line-height:1.2}h1{font-size:3.052em}h2{font-size:2.441em}h3{font-size:1.953em}h4{font-size:1.563em}h5{font-size:1.25em}strong,b{font-weight:700}a{color:var(--accent);font-family:Latin Modern,Georgia,Cambria,Times New Roman,Times,serif}a:hover{color:var(--accent-dark);text-decoration:underline}p{margin-bottom:1em}.prose p{margin-bottom:2em}textarea{width:100%;font-size:16px}input{font-size:16px}table{width:100%}img{max-width:100%;height:auto;border-radius:8px}code{padding:2px 5px;background-color:rgb(var(--gray-light));border-radius:2px;color:rgb(var(--purple))}pre{padding:1.5em;border-radius:8px}pre>code{all:unset}blockquote{border-left:4px solid var(--accent);padding:0 0 0 20px;margin:0;font-size:1.333em}hr{border:none;border-top:1px solid rgb(var(--gray-light))}@media (max-width: 720px){body{font-size:18px}main{padding:1em}}.sr-only{border:0;padding:0;margin:0;position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap}footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}a[data-astro-cid-eimmu3lg]{border-bottom:4px solid transparent;color:var(--black);display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{color:var(--accent);text-decoration:underline}header[data-astro-cid-3ef6ksr2]{margin:0;padding:1rem}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1.5em}h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2],h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{font-weight:400;text-decoration:none}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:center;justify-content:space-between;flex-direction:column}@media (min-width: 720px){nav[data-astro-cid-3ef6ksr2]{flex-direction:row}}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em}nav[data-astro-cid-3ef6ksr2] .logo[data-astro-cid-3ef6ksr2]{color:var(--accent);text-transform:uppercase}.internal-links[data-astro-cid-3ef6ksr2]{font-size:1rem}
main[data-astro-cid-bvzihdzo]{width:calc(100% - 2em);max-width:100%;margin:0}.header[data-astro-cid-bvzihdzo]{color:rgb(var(--dark-gold));display:flex;flex-direction:column;gap:1rem;align-items:center;font-family:Latin Modern,Georgia,Cambria,Times New Roman,Times,serif;justify-content:center;height:75vh}.title[data-astro-cid-bvzihdzo]{text-align:center}.title[data-astro-cid-bvzihdzo] h1[data-astro-cid-bvzihdzo]{font-weight:400;font-size:4rem;font-style:italic}.description[data-astro-cid-bvzihdzo]{font-size:1.25rem;width:720px;max-width:calc(100% - 2em)}.date[data-astro-cid-bvzihdzo]{margin-bottom:.5em}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}.dot-separator[data-astro-cid-bvzihdzo]:after{content:" - "}.reading-time[data-astro-cid-bvzihdzo]{text-transform:uppercase}.prose[data-astro-cid-bvzihdzo]{width:720px;max-width:calc(100% - 2em);margin:auto;padding:1em;color:rgb(var(--gray-dark));h2,h3,h4,h5,h6{margin-top:1em;a{color:inherit;font-size:.75em;margin-left:-1em;text-decoration:none}}}
</style><script type="module">const o=document.querySelectorAll(".prose h2, .prose h3, .prose h4, .prose h5, .prose h6");Array.from(o).forEach(r=>{const e=r.id;r.innerHTML=`<a href="#${e}" aria-hidden="true">#</a> ${r.innerHTML}`});
</script></head> <body data-astro-cid-bvzihdzo> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <h2 data-astro-cid-3ef6ksr2><a href="/" class="logo" data-astro-cid-3ef6ksr2>Jiayi&#39;s Chronicles</a></h2> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Home </a>  <a href="/about" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> About </a>  </div> </nav> </header>  <main data-astro-cid-bvzihdzo> <article data-astro-cid-bvzihdzo> <header class="header" data-astro-cid-bvzihdzo> <div class="title" data-astro-cid-bvzihdzo> <h1 data-astro-cid-bvzihdzo>What I&#39;ve learnt reading Jason Miller&#39;s source code</h1> </div> <p class="description" data-astro-cid-bvzihdzo>A tour of useful JavaScript tricks from his minimal open-source projects</p> <div class="date" data-astro-cid-bvzihdzo> <time datetime="2018-06-24T00:00:00.000Z"> Jun 24, 2018 </time>  <span class="dot-separator" data-astro-cid-bvzihdzo></span> <span class="reading-time" data-astro-cid-bvzihdzo>8 min read</span> </div> </header> <div class="prose" data-astro-cid-bvzihdzo>  <p>Jason Miller is the author of <a href="https://github.com/developit/preact">Preact</a> and he delivers a lot of high-quality small packages like Preact itself. I wanted then to read his source code for some time since I‚Äôm a fan of minimal implementations myself.</p>
<p>Reading his repos is very instructive, for they deal with problems of different nature (DOM, polyfill, bundling etc.) and the source code is minimal enough to be easily comprehensible. When you read a package like <a href="https://github.com/facebook/react">React</a> (*) there‚Äôs so much code which covers only edge cases, but it frightens you from adventuring in.
Besides, when you maintain a minimal lightweight implementation of something, your code aims to be balanced in terms of performance, readability and brevity. Not all the real-world use cases are covered, but that‚Äôs perfect for learning.</p>
<p>Before carrying on, I must mention that not all the following code is necessary from Jason Miller, could surely be from some awesome contributor of his repos.</p>
<h2 id="warning-Ô∏è">Warning ‚ö†Ô∏è</h2>
<p>The following snippets are not meant to be shown as examples of best practices. They are just pieces of code which I found interesting and my explanation could also be different from the original thought by Miller.</p>
<p>Also, many snippets are changed a bit from the original source code to focus on the meaning.</p>
<h1 id="microbundle">Microbundle üì¶</h1>
<p><a href="https://github.com/developit/microbundle">microbundle</a> is a bundler, like Rollup (which is used under-the-hood), for tiny modules and without configuration.</p>
<h2 id="arrayprototypeconcat">Array.prototype.concat</h2>
<p>We start from this first curious snippet of the package:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#6A737D">// source: https://github.com/developit/microbundle/blob/bf2d068dc646fcce976456359ee9c4689b74bea6/src/index.js#L93</span></span>
<span class="line"><span style="color:#E1E4E8">[]</span></span>
<span class="line"><span style="color:#E1E4E8">  .</span><span style="color:#B392F0">concat</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">    options.entries </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#E1E4E8"> options.entries.</span><span style="color:#79B8FF">length</span></span>
<span class="line"><span style="color:#F97583">      ?</span><span style="color:#E1E4E8"> options.entries </span><span style="color:#6A737D">// string[]</span></span>
<span class="line"><span style="color:#F97583">      :</span><span style="color:#E1E4E8"> options.pkg.source </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> options.pkg.module, </span><span style="color:#6A737D">// string</span></span>
<span class="line"><span style="color:#E1E4E8">  )</span></span>
<span class="line"><span style="color:#E1E4E8">  .</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">file</span><span style="color:#F97583"> =></span><span style="color:#B392F0"> glob</span><span style="color:#E1E4E8">(file))</span></span>
<span class="line"><span style="color:#E1E4E8">  .</span><span style="color:#B392F0">forEach</span><span style="color:#E1E4E8">(options.input.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">...</span><span style="color:#E1E4E8">file));</span></span></code></pre>
<p>Starting an expression with <code>[].concat()</code> is not very common, but it takes advantages on <code>Array.prototype.concat</code> which can accept both arrays and single values. I would have written the same code as follows:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> input</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> options.entries </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#E1E4E8"> options.entries.</span><span style="color:#79B8FF">length</span></span>
<span class="line"><span style="color:#F97583">      ?</span><span style="color:#E1E4E8"> options.entries</span></span>
<span class="line"><span style="color:#F97583">      :</span><span style="color:#E1E4E8"> [options.pkg.source </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> options.pkg.module];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">input</span></span>
<span class="line"><span style="color:#E1E4E8">  .</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">file</span><span style="color:#F97583"> =></span><span style="color:#B392F0"> glob</span><span style="color:#E1E4E8">(file))</span></span>
<span class="line"><span style="color:#E1E4E8">  .</span><span style="color:#B392F0">forEach</span><span style="color:#E1E4E8">(options.input.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">...</span><span style="color:#E1E4E8">file));</span></span></code></pre>
<p>I think it‚Äôs more readable but it takes one more variable, which won‚Äôt be used anymore and maybe it would make the reader wondering ‚ÄúWhere else will it be referenced?‚Äú. Also my solution cannot be used as expression, such as in <code>{ input: expression }</code> whereas you can do <code>{ input: [].concat(...) }</code>.</p>
<h2 id="filterboolean">.filter(Boolean)</h2>
<p>I already knew the trick <code>array.filter(Boolean)</code> to remove not truthy values, but this is the next level of it. You can use it to <strong>add optional values in an array using a single expression</strong>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#6A737D">// Source: https://github.com/developit/microbundle/blob/bf2d068dc646fcce976456359ee9c4689b74bea6/src/index.js#L300</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#B392F0">  plugins</span><span style="color:#E1E4E8">: []</span></span>
<span class="line"><span style="color:#E1E4E8">    .</span><span style="color:#B392F0">concat</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#9ECBFF">      'postcss'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      useTypescript </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#9ECBFF"> 'typescript'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#F97583">      !</span><span style="color:#E1E4E8">useTypescript </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#9ECBFF"> 'flow'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'nodent'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      options.compress </span><span style="color:#F97583">!==</span><span style="color:#79B8FF"> false</span><span style="color:#F97583"> &#x26;&#x26;</span><span style="color:#E1E4E8"> [</span><span style="color:#9ECBFF">'uglify'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'anotherPlugin'</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">    )</span></span>
<span class="line"><span style="color:#E1E4E8">    .</span><span style="color:#B392F0">filter</span><span style="color:#E1E4E8">(Boolean)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>If <code>useTypescript === false</code> and <code>options.compress !== false</code>, then the result will be</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">[]</span></span>
<span class="line"><span style="color:#E1E4E8">  .</span><span style="color:#B392F0">concat</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">    [</span><span style="color:#9ECBFF">'postcss'</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'flow'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'nodent'</span><span style="color:#E1E4E8">, [</span><span style="color:#9ECBFF">'uglify'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'anotherPlugin'</span><span style="color:#E1E4E8">]]</span></span>
<span class="line"><span style="color:#E1E4E8">  )</span></span>
<span class="line"><span style="color:#E1E4E8">  .</span><span style="color:#B392F0">filter</span><span style="color:#E1E4E8">(Boolean);</span></span>
<span class="line"><span style="color:#6A737D">// Returns ['postcss', 'flow', 'nodent', 'uglify', 'anotherPlugin']</span></span></code></pre>
<h2 id="unique-values">Unique values</h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#6A737D">// Source: https://github.com/developit/microbundle/blob/bf2d068dc646fcce976456359ee9c4689b74bea6/src/index.js#L117</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">entries.</span><span style="color:#B392F0">filter</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">item</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">i</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">arr</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> arr.</span><span style="color:#B392F0">indexOf</span><span style="color:#E1E4E8">(item) </span><span style="color:#F97583">===</span><span style="color:#E1E4E8"> i)</span></span></code></pre>
<p>It gets an <strong>array of unique values</strong> by cleverly removing duplicate items, which will have <code>arr.indexOf(item)</code> returning a smaller index. I usually use another solution based on <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Set">ES6 Set</a>, which stores unique values by definition, but this one from <code>microbundle</code> is a nice ES5 alternative.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> unique</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> Array.</span><span style="color:#B392F0">from</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">new</span><span style="color:#B392F0"> Set</span><span style="color:#E1E4E8">(entries));</span></span></code></pre>
<h1 id="workerize-Ô∏è">Workerize üèóÔ∏è</h1>
<p><a href="https://github.com/developit/workerize">workerize</a> allows to run then code, passed as a string, in a <strong>Web Worker</strong>. Example from the doc:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">let</span><span style="color:#E1E4E8"> worker </span><span style="color:#F97583">=</span><span style="color:#B392F0"> workerize</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`</span></span>
<span class="line"><span style="color:#9ECBFF">	export function add(a, b) {</span></span>
<span class="line"><span style="color:#9ECBFF">		let start = Date.now();</span></span>
<span class="line"><span style="color:#9ECBFF">		while (Date.now() - start &#x3C; 500);</span></span>
<span class="line"><span style="color:#9ECBFF">		return a + b;</span></span>
<span class="line"><span style="color:#9ECBFF">	}</span></span>
<span class="line"><span style="color:#9ECBFF">`</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">(</span><span style="color:#F97583">async</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	console.</span><span style="color:#B392F0">log</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'3 + 9 = '</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">await</span><span style="color:#E1E4E8"> worker.</span><span style="color:#B392F0">add</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">9</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#E1E4E8">	console.</span><span style="color:#B392F0">log</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'1 + 2 = '</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">await</span><span style="color:#E1E4E8"> worker.</span><span style="color:#B392F0">add</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#E1E4E8">})();</span></span></code></pre>
<h2 id="blob-url-worker">Blob URL Worker</h2>
<p>The source code of the package is about 70 LOC and for me the most interesting lines are the following:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#6A737D">// Source: https://github.com/developit/workerize/blob/683631f402443d71484b03d087b37c72e65f2e3d/src/index.js#L25</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> code</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> `export function add(a, b) { ... }`</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> url</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> URL</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">createObjectURL</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">new</span><span style="color:#B392F0"> Blob</span><span style="color:#E1E4E8">([code]));</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> worker</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Worker</span><span style="color:#E1E4E8">(url, options);</span></span></code></pre>
<p>Basically, it <strong>allows to create a Web Worker without any separate JS file</strong>, by passing a String URL which represents a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Blob">Blob</a>, which in turn is a file-like object containing the source code. Try the following snippet in Chrome console to see it working:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> url</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> URL</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">createObjectURL</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">new</span><span style="color:#B392F0"> Blob</span><span style="color:#E1E4E8">([</span><span style="color:#9ECBFF">'postMessage("Hi from the Worker")'</span><span style="color:#E1E4E8">]))</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> worker</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Worker</span><span style="color:#E1E4E8">(url);</span></span>
<span class="line"><span style="color:#E1E4E8">worker.</span><span style="color:#B392F0">onmessage</span><span style="color:#F97583"> =</span><span style="color:#FFAB70"> e</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> console.</span><span style="color:#B392F0">log</span><span style="color:#E1E4E8">(e.data);</span></span></code></pre>
<h1 id="greenlet">Greenlet ü¶é</h1>
<p><a href="https://github.com/developit/greenlet">greelet</a> is like <code>workerize</code> but for single functions.</p>
<h2 id="data-url-worker">Data URL Worker</h2>
<p>In the previous case, we have seen how a Web Worker can be created using just a Blob URL, but this package shows that you can achieve the same result also using <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/Data_URIs">Data URL</a>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#6A737D">// Source: https://github.com/developit/greenlet/blob/d4d3f0d903ef34df69443f6f86a81d0fa6035c56/greenlet.js#L15</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> worker</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Worker</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#9ECBFF">  'data:,$$='</span><span style="color:#F97583">+</span><span style="color:#E1E4E8">asyncFunction</span><span style="color:#F97583">+</span><span style="color:#9ECBFF">';onmessage='</span><span style="color:#F97583">+</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">e</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // $$ is a global variable storing the function to "workerize"</span></span>
<span class="line"><span style="color:#6A737D">    // ... other `onmessage` callback stuff</span></span>
<span class="line"><span style="color:#E1E4E8">  })</span></span>
<span class="line"><span style="color:#E1E4E8">);</span></span></code></pre>
<p>The lib cleverly <strong>creates a Web Worker using just Data URL</strong> where the function and <code>onmessage</code> callback are stringified. Try running the following snippet in Chrome console:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> worker</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Worker</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'data:,postMessage("Hi from the Web Worker")'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">worker.</span><span style="color:#B392F0">onmessage</span><span style="color:#F97583"> =</span><span style="color:#FFAB70"> e</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> console.</span><span style="color:#B392F0">log</span><span style="color:#E1E4E8">(e.data);</span></span></code></pre>
<h1 id="mitt">mitt ü•ä</h1>
<p><a href="https://github.com/developit/mitt">mitt</a> is a tiny event-emitter library, to create event subscription like <code>window.addEventListener('click', fn)</code>. It‚Äôs just 200 bytes gzipped, but nevertheless there‚Äôs always something to learn:</p>
<h2 id="bitwise-operator">Bitwise operator ‚Äô>>>‚Äò</h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#6A737D">// Source: https://github.com/developit/mitt/blob/f38922aa9190c9126c8fdc3306b32bd2c248b77e/src/index.js#L44</span></span>
<span class="line"><span style="color:#B392F0">off</span><span style="color:#E1E4E8">(name, handler) {</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (handlers[name]) {</span></span>
<span class="line"><span style="color:#E1E4E8">    handlers[name].</span><span style="color:#B392F0">splice</span><span style="color:#E1E4E8">(handlers[name].</span><span style="color:#B392F0">indexOf</span><span style="color:#E1E4E8">(handler) </span><span style="color:#F97583">>>></span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The implementation of the <code>.off</code> method, which allows to remove an event handler, uses the bitwise operator <code>>>></code>. I never use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Bitwise_Operators#Unsigned_right_shift">bitwise operators</a> because they are clever solutions but so difficult to understand and it‚Äôs not worth it (usually).</p>
<p><code>9 >>> 2</code> shifts 9 (<code>1001</code> in binary) of 2 bits to the right, resulting in 2 (<code>10</code> in binary).</p>
<p><code>all[type].indexOf(handler) >>> 0</code> then doesn‚Äôt do anything usually because it shifts, the <strong>positive</strong> index, of 0 bits that is leaving it untouched. But when <code>.indexOf(handler)</code> doesn‚Äôt find the handler, it returns <code>-1</code> and <code>-1 >>> 0</code> yields a huge number <code>4294967295</code>. This is caused by the <a href="http://2ality.com/2012/04/number-encoding.html">standard used by JS to encode numbers</a>.</p>
<p>Combine this information with the awareness that, from <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/splice#Syntax">MDN documentation</a>, <code>splice</code> won‚Äôt do anything if called with a value greater than the length of the array.</p>
<p>We can conclude then that the bitwise operator is used to avoid <code>.splice</code> removing any item if the handler is not found. All without first checking if the item is present.</p>
<p>However this usage of <code>>>></code> reminds me of another bitwise operator: <code>~</code> (NOT operator). It‚Äôs usually used in boolean expressions, such as in:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">~</span><span style="color:#E1E4E8">array.</span><span style="color:#B392F0">indexOf</span><span style="color:#E1E4E8">(item)) {</span></span>
<span class="line"><span style="color:#F97583">  ...</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Put simply, given a number <code>x</code>, <code>~x</code> it yields <code>-(x + 1)</code>, so when <code>.indexOf</code> returns <code>-1</code>:</p>
<p><code>if(~(-1)) === if (-(-1+1)) == if (0) == if (false)</code></p>
<p>How to be hated by your colleagues in one character üòÑ</p>
<h1 id="unfetch">unfetch üê∂</h1>
<p><a href="https://github.com/developit/unfetch">unfetch</a> is a 500Bytes polyfill of native <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">fetch API</a>.</p>
<h2 id="bitwise-again-with--operator">Bitwise again with ‚Äô|‚Äô operator</h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#6A737D">// Source: https://github.com/developit/unfetch/blob/55560157515dc32b4612daf2653d0300c6ddbe7c/src/index.js#L36</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> responseOkay</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> ((request.status </span><span style="color:#F97583">/</span><span style="color:#79B8FF"> 100</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">|</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8">; </span><span style="color:#6A737D">// 200-299</span></span></code></pre>
<p>If you liked the previous snippets with bitwise operators, you‚Äôll love this one.<br>
To control if the network response status is between 200-299, which means the request was successful, the bitwise operator <code>|</code> is used to floor the number and check if it‚Äôs equal to 2. Apparently this is much faster than usual <code>status >= 200 &#x26;&#x26; status &#x3C; 300</code> according to this <a href="https://jsperf.com/or-vs-floor/2">jsperf test</a>.</p>
<h2 id="decko">Decko üí®</h2>
<p>It happens even to the best of us: the following is a wrong implementation of neither <code>throttle</code> nor <code>debounce</code> and it‚Äôs taken from <a href="https://github.com/developit/decko">Decko</a>, a lib for 3 very useful decorators:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> debounce</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">fn</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">delay</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#F97583"> function</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">...</span><span style="color:#FFAB70">a</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">    args </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> a;</span></span>
<span class="line"><span style="color:#E1E4E8">    context </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">timer) timer </span><span style="color:#F97583">=</span><span style="color:#B392F0"> setTimeout</span><span style="color:#E1E4E8">( () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">      fn.</span><span style="color:#B392F0">apply</span><span style="color:#E1E4E8">(context, args);</span></span>
<span class="line"><span style="color:#E1E4E8">      args </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> context </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> timer </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }, delay);</span></span>
<span class="line"><span style="color:#E1E4E8">  };</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>In my opinion, it‚Äôs wrong because it always calls the function <code>fn</code> after <code>delay</code> ms, even if there are other calls during the time span, whereas a correct debounce waits for <code>delay</code> ms <em>without any call</em>.</p>
<p>Suppose we represent 1ms as <code>-</code> (hyphen) and 3 calls of the debounced function with a delay of <code>4s</code>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>Debounce from Decko:</span></span>
<span class="line"><span>--a--b-----c----</span></span>
<span class="line"><span>------b--------c // &#x3C;= b is wrong, should delay 4s from its call, not from the call of `a`</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Correct debounce:</span></span>
<span class="line"><span>--a--b-----c----</span></span>
<span class="line"><span>---------b-----c</span></span></code></pre>
<p>The reason because it‚Äôs also an incorrect implementation of <code>throttle</code> is left to you, but you can read more about it in <a href="https://remysharp.com/2010/07/21/throttling-function-calls">Throttling function calls</a>. Anyway, there‚Äôs already <a href="https://github.com/developit/decko/issues/9">an open issue in decko about debounce</a>.</p>
<p>This teaches us that it‚Äôs okay not knowing to implement perfectly all this stuff and still be great. We all learn by making mistakes and it takes time.</p>
<h2 id="conclusion">Conclusion</h2>
<p>We have seen a lot of interesting tricks, some questionable, but knowledge is always useful. I left <code>Preact</code> out this article because it‚Äôs already quite long, but maybe next time I‚Äôll publish <em>‚ÄúWhat I‚Äôve learnt reading Preact source code‚Äù</em> üòÑ</p>
<p>In the meanwhile, I suggest you do the same with the packages mentioned in the article and comment on any other trick you discovered!</p>
<hr>
<p>(*): nevertheless the React team tries a lot to help you to get started on their source code</p>   <script src="https://giscus.app/client.js" data-repo="jiayihu/blog" data-repo-id="MDEwOlJlcG9zaXRvcnk1ODc1MTUxMA==" data-category="Announcements" data-category-id="DIC_kwDOA4B6Fs4Ce90Z" data-mapping="title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="en" data-loading="lazy" crossorigin="anonymous" async></script> </div> </article> </main> <footer data-astro-cid-sz7xmlte>
&copy; 2024 Jiayi Hu. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte> <a href="https://twitter.com/jiayi0x10" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Follow Astro on Twitter</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-sz7xmlte><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://github.com/jiayihu" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Jiayi's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://www.linkedin.com/in/jiayi-hu/" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Jiayi's LinkedIn page</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/linkedin" data-astro-cid-sz7xmlte> <path fill="currentColor" d="M13.632 13.635h-2.37V9.922c0-.886-.018-2.025-1.234-2.025-1.235 0-1.424.964-1.424 1.96v3.778h-2.37V6H8.51V7.04h.03c.318-.6 1.092-1.233 2.247-1.233 2.4 0 2.845 1.58 2.845 3.637v4.188zM3.558 4.955c-.762 0-1.376-.617-1.376-1.377 0-.758.614-1.375 1.376-1.375.76 0 1.376.617 1.376 1.375 0 .76-.617 1.377-1.376 1.377zm1.188 8.68H2.37V6h2.376v7.635zM14.816 0H1.18C.528 0 0 .516 0 1.153v13.694C0 15.484.528 16 1.18 16h13.635c.652 0 1.185-.516 1.185-1.153V1.153C16 .516 15.467 0 14.815 0z" fill-rule="nonzero" data-astro-cid-sz7xmlte></path> </svg> </a> </div> </footer>  </body></html>