<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><!-- Favicons --><link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png"><link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#5bbad5"><meta name="generator" content="Astro v4.3.2"><!-- Canonical URL --><link rel="canonical" href="https://blog.jiayihu.net/k3s-alpine-linux-raspberry/"><!-- Primary Meta Tags --><title>Install k3s with Alpine Linux on Raspberry Pi 3B+</title><meta name="title" content="Install k3s with Alpine Linux on Raspberry Pi 3B+"><meta name="description" content="A step to step guide to run k3s on Alpine Linux using Ansible playbook"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://blog.jiayihu.net/k3s-alpine-linux-raspberry/"><meta property="og:title" content="Install k3s with Alpine Linux on Raspberry Pi 3B+"><meta property="og:description" content="A step to step guide to run k3s on Alpine Linux using Ansible playbook"><meta property="og:image" content="https://blog.jiayihu.net/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://blog.jiayihu.net/k3s-alpine-linux-raspberry/"><meta property="twitter:title" content="Install k3s with Alpine Linux on Raspberry Pi 3B+"><meta property="twitter:description" content="A step to step guide to run k3s on Alpine Linux using Ansible playbook"><meta property="twitter:image" content="https://blog.jiayihu.net/blog-placeholder-1.jpg"><meta name="google-site-verification" content="6DIBzCM2sFIHFrOECCKoODFkMjWkvkmxMqJD0EFb7xU"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="apple-mobile-web-app-title" content="Jiayi's Chronicles"><meta name="msapplication-TileColor" content="#ffffff"><meta name="theme-color" content="#ffffff"><style>:root{--accent: #a00;--accent-dark: rgb(110, 1, 1);--black: 15, 18, 25;--sand: 255, 252, 250;--dark-gold: 90, 68, 13;--purple: 111, 66, 193;--gray: 96, 115, 159;--gray-light: 229, 233, 240;--gray-dark: 34, 41, 57;--gray-gradient: rgba(var(--sand), 100%), #fff;--box-shadow: 0 2px 6px rgba(var(--gray), 25%), 0 8px 24px rgba(var(--gray), 33%), 0 16px 32px rgba(var(--gray), 33%)}body{font-family:-apple-system,BlinkMacSystemFont,avenir next,avenir,helvetica neue,helvetica,ubuntu,roboto,noto,segoe ui,arial,sans-serif;margin:0;padding:0;text-align:left;background:linear-gradient(var(--gray-gradient)) no-repeat;background-size:100% 600px;word-wrap:break-word;overflow-wrap:break-word;color:rgb(var(--gray-dark));font-size:16px;line-height:1.7}main{width:720px;max-width:calc(100% - 2em);margin:auto;padding:3em 1em}h1,h2,h3,h4,h5,h6{font-family:Latin Modern,Georgia,Cambria,Times New Roman,Times,serif;font-weight:400;margin:0 0 .5rem;line-height:1.2}h1{font-size:3.052em}h2{font-size:2.441em}h3{font-size:1.953em}h4{font-size:1.563em}h5{font-size:1.25em}strong,b{font-weight:700}a{color:var(--accent);font-family:Latin Modern,Georgia,Cambria,Times New Roman,Times,serif}a:hover{color:var(--accent-dark);text-decoration:underline}p{margin-bottom:1em}.prose p{margin-bottom:2em}textarea{width:100%;font-size:16px}input{font-size:16px}table{width:100%}img{max-width:100%;height:auto;border-radius:8px}code{padding:2px 5px;background-color:rgb(var(--gray-light));border-radius:2px;color:rgb(var(--purple))}pre{padding:1.5em;border-radius:8px}pre>code{all:unset}blockquote{border-left:4px solid var(--accent);padding:0 0 0 20px;margin:0;font-size:1.333em}hr{border:none;border-top:1px solid rgb(var(--gray-light))}@media (max-width: 720px){body{font-size:18px}main{padding:1em}}.sr-only{border:0;padding:0;margin:0;position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap}footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}a[data-astro-cid-eimmu3lg]{border-bottom:4px solid transparent;color:var(--black);display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{color:var(--accent);text-decoration:underline}header[data-astro-cid-3ef6ksr2]{margin:0;padding:1rem}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1.5em}h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2],h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{font-weight:400;text-decoration:none}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:center;justify-content:space-between;flex-direction:column}@media (min-width: 720px){nav[data-astro-cid-3ef6ksr2]{flex-direction:row}}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em}nav[data-astro-cid-3ef6ksr2] .logo[data-astro-cid-3ef6ksr2]{color:var(--accent);text-transform:uppercase}.internal-links[data-astro-cid-3ef6ksr2]{font-size:1rem}
main[data-astro-cid-bvzihdzo]{width:calc(100% - 2em);max-width:100%;margin:0}.header[data-astro-cid-bvzihdzo]{color:rgb(var(--dark-gold));display:flex;flex-direction:column;gap:1rem;align-items:center;font-family:Latin Modern,Georgia,Cambria,Times New Roman,Times,serif;justify-content:center;height:75vh}.title[data-astro-cid-bvzihdzo]{text-align:center}.title[data-astro-cid-bvzihdzo] h1[data-astro-cid-bvzihdzo]{font-weight:400;font-size:4rem;font-style:italic}.description[data-astro-cid-bvzihdzo]{font-size:1.25rem;width:720px;max-width:calc(100% - 2em)}.date[data-astro-cid-bvzihdzo]{margin-bottom:.5em}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}.dot-separator[data-astro-cid-bvzihdzo]:after{content:" - "}.reading-time[data-astro-cid-bvzihdzo]{text-transform:uppercase}.prose[data-astro-cid-bvzihdzo]{width:720px;max-width:calc(100% - 2em);margin:auto;padding:1em;color:rgb(var(--gray-dark));h2,h3,h4,h5,h6{margin-top:1em;a{color:inherit;font-size:.75em;margin-left:-1em;text-decoration:none}}}
</style><script type="module">const o=document.querySelectorAll(".prose h2, .prose h3, .prose h4, .prose h5, .prose h6");Array.from(o).forEach(r=>{const e=r.id;r.innerHTML=`<a href="#${e}" aria-hidden="true">#</a> ${r.innerHTML}`});
</script></head> <body data-astro-cid-bvzihdzo> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <h2 data-astro-cid-3ef6ksr2><a href="/" class="logo" data-astro-cid-3ef6ksr2>Jiayi&#39;s Chronicles</a></h2> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Home </a>  <a href="/about" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> About </a>  </div> </nav> </header>  <main data-astro-cid-bvzihdzo> <article data-astro-cid-bvzihdzo> <header class="header" data-astro-cid-bvzihdzo> <div class="title" data-astro-cid-bvzihdzo> <h1 data-astro-cid-bvzihdzo>Install k3s with Alpine Linux on Raspberry Pi 3B+</h1> </div> <p class="description" data-astro-cid-bvzihdzo>A step to step guide to run k3s on Alpine Linux using Ansible playbook</p> <div class="date" data-astro-cid-bvzihdzo> <time datetime="2020-12-19T00:00:00.000Z"> Dec 19, 2020 </time>  <span class="dot-separator" data-astro-cid-bvzihdzo></span> <span class="reading-time" data-astro-cid-bvzihdzo>8 min read</span> </div> </header> <div class="prose" data-astro-cid-bvzihdzo>  <p>I’ve been recently started experimenting with Raspberry Pi 3B+ and Kubernetes for my thesis. Because of the constrained resources on devices like the Pis, I’ve chosen <a href="https://k3s.io/">K3s</a> as Kubernetes distribution meant for IoT and Edge, though I have more to say about that later.</p>
<p>Setting up Ubuntu Server and K3s on the Raspberry Pi cluster was pretty straightforward thanks to <a href="https://github.com/k3s-io/k3s-ansible">k3s-ansible</a>. I’ve started using Ansible only recently, but I’m loving it. It’s a well-done configuration management tool that makes configuring and running commands on the nodes much more effortless. You can run commands across all the nodes or define automated configuration called <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html">playbooks</a>. We’re going to use it in this blog post.</p>
<p>Because of the limited available RAM (1GB on my Pi 3B+), I decided to migrate from Ubuntu Server to Alpine Linux. Ubuntu Server was eating about ~400MB, whereas k3s server uses an additional ~400MB even without any application running. K3s agent is around 128MB of memory usage. That doesn’t leave very much memory available con the server, even before running other applications like Prometheus monitoring. That’s why I decided to move to <a href="https://alpinelinux.org/">Alpine Linux</a>, which is often used as base image in containers because it’s very minimal and lightweight. It takes about 120MB uncompressed and it uses only about 50MB of RAM in my case. It can be even less resource-demanding if one is using the container distribution, such as only 8MB of RAM.</p>
<p>Let’s cut the crap and jump to the point.</p>
<h2 id="installing">Installing</h2>
<p>Download your favourite Alpine Linux distribution at <a href="https://alpinelinux.org/downloads/">https://alpinelinux.org/downloads/</a>. The distribution I’ve picked is <code>aarch64</code> since the Raspberry Pi 3B+ has 64bit cores.</p>
<p>After having unzipped the files, copy them over to the SD card. Remove the SD card and boot the Pi with it.</p>
<p>After the initial setup with <code>setup-alpine</code> run the following commands.</p>
<p>Update the packages:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>apk update</span></span>
<span class="line"><span>apk upgrade</span></span></code></pre>
<p>Enable root SSH so that we can continue the following commands on our usual laptop/computer. Alpine Linux uses <a href="https://docs.alpinelinux.org/user-handbook/0.1a/Working/openrc.html">OpenRC</a> instead of <code>systemd</code>, therefore we’ll have to restart the <code>sshd</code> service with <code>rc-service</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>vi /etc/ssh/sshd_config</span></span>
<span class="line"><span>rc-service sshd restart</span></span></code></pre>
<p>Add <code>/etc/init.d</code> and <code>add /root/.ssh</code> to <code>lbu</code>. lbu is the <a href="https://wiki.alpinelinux.org/wiki/Alpine_local_backup">Alpine local backup</a> because it’s diskless by default, meaning that all the modifications must be saved to an overlay file (.apkovl) to make them survive a reboot.</p>
<p>You can try different instructions at <a href="https://wiki.alpinelinux.org/wiki/Raspberry_Pi_4_-_Persistent_system_acting_as_a_NAS_and_Time_Machine">Raspberry Pi 4 - Persistent system acting as a NAS and Time Machine</a> if you want a fully classic persistent filesystem, but you have to start from scratch making the partitions. Personally, I was able to create the partitions but then I had issues with the <code>wlan0</code> not working, but I didn’t actually invest very much time to investigate the issue.</p>
<p>What we’re configuring in this blog post is a diskless minimal Alpine Linux. We’ll manually commit changes so that we can’t check and choose what to actually persist after a reboot. Then we’ll create an automatically persisted <a href="https://wiki.archlinux.org/index.php/Overlay_filesystem">Overlay filesystem</a> for only some specific folders:</p>
<ul>
<li><code>/root</code> the home root where we download binaries</li>
<li><code>/var/lib/rancher</code> where k3s saves data</li>
<li><code>/usr</code> to save packages in the overlay layer instead of the lbu backup, but it’s optional</li>
</ul>
<p>This configuration allows having a minimal Alpine Linux reset after each reboot, whereas k3s will be saved in the overlay layer. So after a reboot, k3s will still have the information like authentication token, node passwords, DNS records etc. kept. However, in case of trouble, the overlay layer can be deleted, the system reset with reboot and k3s reinstalled automatically using Ansible.</p>
<p>Add <code>/etc/init.d</code> and <code>/root/.ssh</code> to the folders included by lbu. By default it tracks only <code>/etc</code>, with <code>/etc/init.d</code> excluded. We also set the lbu backup-limit up to 5 versions, so that you don’t always need to overwrite the previous backup if you are experimenting with some changes.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>lbu add /etc/init.d</span></span>
<span class="line"><span>lbu add /root/.ssh</span></span>
<span class="line"><span>vi /etc/lbu/lbu.conf # BACKUP_LIMIT=5</span></span></code></pre>
<p>Register the <code>wpa_supplicant</code> service, otherwise, in my case I wasn’t able to get a DHCP lease from the wifi after reboot. More info is available at <a href="https://gitlab.alpinelinux.org/alpine/aports/-/issues/8025">https://gitlab.alpinelinux.org/alpine/aports/-/issues/8025</a>, with also an example of what to write in <code>/etc/init.d/networking</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span># Add wpa_supplicant service</span></span>
<span class="line"><span>rc-update add wpa_supplicant default</span></span>
<span class="line"><span>vi /etc/init.d/networking # need wpa_supplicant</span></span>
<span class="line"><span>rc-update -u</span></span>
<span class="line"><span>lbu ci -d</span></span></code></pre>
<p>Restrict SSH login with SSH key, disabling password authentication: <code>ssh-copy-id root@192.168.1.100</code>. This needs to be run in your laptop, not within the SSH session and <code>192.168.1.100</code> is the IP address of the Raspberry Pi.</p>
<p>After the key have been copied, check it is at <code>~/.ssh/authorized_keys</code>. The disable password authentication.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>vi /etc/ssh/sshd_config # PasswordAuthentication no</span></span>
<span class="line"><span>rc-service sshd restart</span></span></code></pre>
<p>Install python needed by Ansible</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>apk add python3</span></span></code></pre>
<p>Now let’s create the Overlay filesystem. Commands are adapted from <a href="https://wiki.alpinelinux.org/wiki/Raspberry_Pi#Persistent_storage">https://wiki.alpinelinux.org/wiki/Raspberry_Pi#Persistent_storage</a>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>mount /media/mmcblk0p1 -o rw,remount</span></span>
<span class="line"><span>sed -i 's/vfat\ ro,/vfat\ rw,/' /etc/fstab</span></span>
<span class="line"><span>dd if=/dev/zero of=/media/mmcblk0p1/persist.img bs=1024 count=0 seek=1048576</span></span>
<span class="line"><span>apk add e2fsprogs</span></span>
<span class="line"><span>mkfs.ext4 /media/mmcblk0p1/persist.img</span></span>
<span class="line"><span>echo "/media/mmcblk0p1/persist.img /media/persist ext4 rw,relatime,errors=remount-ro 0 0" >> /etc/fstab</span></span>
<span class="line"><span>mkdir /media/persist </span></span>
<span class="line"><span>mount -a</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Persist /usr</span></span>
<span class="line"><span>mkdir /media/persist/usr</span></span>
<span class="line"><span>mkdir /media/persist/.work</span></span>
<span class="line"><span>echo "overlay /usr overlay lowerdir=/usr,upperdir=/media/persist/usr,workdir=/media/persist/.work 0 0" >> /etc/fstab </span></span>
<span class="line"><span>mount -a</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Persist /var/lib/rancher</span></span>
<span class="line"><span>mkdir /media/persist/rancher </span></span>
<span class="line"><span>mkdir /media/persist/.work-rancher</span></span>
<span class="line"><span>mkdir /var/lib/rancher</span></span>
<span class="line"><span>echo "overlay /var/lib/rancher overlay lowerdir=/var/lib/rancher,upperdir=/media/persist/rancher,workdir=/media/persist/.work-rancher 0 0" >> /etc/fstab </span></span>
<span class="line"><span>mount -a</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Persist /root</span></span>
<span class="line"><span>mkdir /media/persist/root </span></span>
<span class="line"><span>mkdir /media/persist/.work-root</span></span>
<span class="line"><span>echo "overlay /root overlay lowerdir=/root,upperdir=/media/persist/root,workdir=/media/persist/.work-root 0 0" >> /etc/fstab </span></span>
<span class="line"><span>mount -a</span></span>
<span class="line"><span></span></span>
<span class="line"><span>cat /etc/fstab # Check everything is fine</span></span></code></pre>
<p>Enable OpenRC logging, by setting <code>rc_logger="YES"</code> in the file. You will find service boot logs at <code>/var/log/rc.log</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>vi /etc/rc.conf # rc_logger="YES"</span></span></code></pre>
<p>Commit all changes and reboot the machine.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>lbu ci -d</span></span>
<span class="line"><span>reboot</span></span></code></pre>
<p>Check that everything is working as expected. Check that <code>python3</code> is available as well as the folder <code>/var/lib/rancher</code>. Now it’s time to install k3s and we’re using Ansible for that.</p>
<h2 id="install-k3s-with-ansible">Install k3s with Ansible</h2>
<p>The changes needed to run Ansible with <code>k3s-ansible</code> are available in my Pull Request <a href="https://github.com/k3s-io/k3s-ansible/pull/107/">k3s-ansible#107</a>. You can copy them into your local Ansible configuration.</p>
<p>Compared to the standard Ubuntu installation, the following steps are different or needed in Alpine. I’ll write the bare shell commands for anyone not using Ansible, although I strongly encourage to use the latter and see my PR for the configuration.</p>
<p>Add the <code>cgroup</code> mount point:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>echo "cgroup /sys/fs/cgroup cgroup defaults 0 0" >> /etc/fstab</span></span></code></pre>
<p>Add the following lines to <code>/etc/cgconfig.conf</code> (e.g. <code>vi /etc/cgconfig.conf</code>):</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>mount {</span></span>
<span class="line"><span>  cpuacct = /cgroup/cpuacct;</span></span>
<span class="line"><span>  memory = /cgroup/memory;</span></span>
<span class="line"><span>  devices = /cgroup/devices;</span></span>
<span class="line"><span>  freezer = /cgroup/freezer;</span></span>
<span class="line"><span>  net_cls = /cgroup/net_cls;</span></span>
<span class="line"><span>  blkio = /cgroup/blkio;</span></span>
<span class="line"><span>  cpuset = /cgroup/cpuset;</span></span>
<span class="line"><span>  cpu = /cgroup/cpu;</span></span>
<span class="line"><span>}</span></span></code></pre>
<p>Enable cgroup via boot commandline, by appending the following line to <code>/media/mmcblk0p1/cmdline.txt</code>. <code>/media/mmcblk0p1</code> is where the boot files are saved, including the lbu backups and the overlay image (<code>persist.img</code>). It’s usually at path <code>/boot</code> :</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>default_kernel_opts="...  cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory"</span></span></code></pre>
<p>Now you can download the k3s binaries. If you want to enable them as services running at boot, you can create the following services at <code>/etc/init.d/k3s</code> and symlink at <code>/etc/runlevels/default/k3s</code> to run them as <code>default</code> runlevel.</p>
<p>K3s server</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>#!/sbin/openrc-run</span></span>
<span class="line"><span>name="k3s server"</span></span>
<span class="line"><span>command="/usr/local/bin/k3s"</span></span>
<span class="line"><span>command_args="server"</span></span>
<span class="line"><span>command_background=true</span></span>
<span class="line"><span>pidfile="/run/${RC_SVCNAME}.pid"</span></span>
<span class="line"><span>output_log="/var/log/k3s.log"</span></span>
<span class="line"><span>error_log="/var/log/k3s.err"</span></span></code></pre>
<p>K3s agent, where <code>{{ master_ip }}</code> is the IP of the k3s server and <code>{{ token }}</code> can be found at <code>/var/lib/rancher/k3s/server/node-token</code> on the server node. It will be available after the first successful run of k3s server.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>#!/sbin/openrc-run</span></span>
<span class="line"><span>name="k3s agent"</span></span>
<span class="line"><span>command="/usr/local/bin/k3s"</span></span>
<span class="line"><span>command_args="agent --server https://{{ master_ip }}:6443 --token {{ token }}"</span></span>
<span class="line"><span>command_background=true</span></span>
<span class="line"><span>pidfile="/run/${RC_SVCNAME}.pid"</span></span>
<span class="line"><span>output_log="/var/log/k3s.log"</span></span>
<span class="line"><span>error_log="/var/log/k3s.err"</span></span></code></pre>
<p>Check if the changes are working as intended and reboot.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>lbu status</span></span>
<span class="line"><span>lbu ci -d</span></span>
<span class="line"><span>reboot</span></span></code></pre>
<p>After the reboot, the services should start and the k3s cluster will be up and running for the first time. Copy the kubeconfig from the server node to laptop.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>scp root@192.168.1.1:~/.kube/config ~/.kube/config</span></span></code></pre>
<p>Still on the laptop shell, set the <code>KUBECONFIG</code> env variable and check if the cluster is up and running.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>export KUBECONFIG=~/.kube/config</span></span>
<span class="line"><span>kubectl get nodes</span></span></code></pre>
<p>You should have something like:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>NAME     STATUS   ROLES    AGE     VERSION</span></span>
<span class="line"><span>rasp-1   Ready    master   3m   v1.17.5+k3s1</span></span>
<span class="line"><span>rasp-3   Ready    &#x3C;none>   3m   v1.17.5+k3s1</span></span>
<span class="line"><span>rasp-4   Ready    &#x3C;none>   3m   v1.17.5+k3s1</span></span>
<span class="line"><span>rasp-2   Ready    &#x3C;none>   3m   v1.17.5+k3s1</span></span></code></pre>
<h2 id="resources">Resources</h2>
<p>The previous commands are the result of my experiments. I’ll link the articles which helped me configure the system.</p>
<ul>
<li><a href="https://rancher.com/docs/k3s/latest/en/architecture/">k3s architecture</a> to know where token and passwords are stored</li>
<li><a href="https://d-heinrich.medium.com/k3s-bootstrap-on-alpine-linux-c207c85c3f3d">k3s bootstrap on Alpine Linux</a> bare commands to run without Ansible</li>
<li><a href="https://wiki.alpinelinux.org/wiki/Alpine_Linux_Init_System">Alpine Linux Init System</a> as quick cheatsheet of OpenRC commands</li>
<li><a href="https://wiki.alpinelinux.org/wiki/Alpine_local_backup">Alpine local backup</a> to learn about lbu</li>
<li><a href="https://wiki.alpinelinux.org/wiki/Raspberry_Pi">wiki.alpinelinux/Raspberry Pi</a> from which most commands are taken</li>
<li><a href="https://github.com/OpenRC/openrc/blob/master/service-script-guide.md">OpenRC Service Script Writing Guide</a></li>
</ul>
<h2 id="conclusions-on-alpine-linux-and-k3s">Conclusions on Alpine Linux and K3s</h2>
<p>The whole process is challenging but the results are worth it.</p>
<p>Alpine Linux uses only ~55MB on my Raspberry Pi 3B+. Now, most resources are used by k3s-server and k3s-agent. K3s-server now takes about 500MB of RAM and I guess it’s because Go prefers to increase the memory consumption instead of running garbage collection cycles. K3s-agent takes approx 128MB of memory.</p>
<p>There’s an ongoing issue <a href="https://github.com/k3s-io/k3s/issues/2278">k3s#2278</a> about k3s CPU and memory usage, which should be less considering it’s described as k8s for IoT and Edge. I hope it improves in future.</p>   <script src="https://giscus.app/client.js" data-repo="jiayihu/blog" data-repo-id="MDEwOlJlcG9zaXRvcnk1ODc1MTUxMA==" data-category="Announcements" data-category-id="DIC_kwDOA4B6Fs4Ce90Z" data-mapping="title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="en" data-loading="lazy" crossorigin="anonymous" async></script> </div> </article> </main> <footer data-astro-cid-sz7xmlte>
&copy; 2024 Jiayi Hu. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte> <a href="https://twitter.com/jiayi0x10" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Follow Astro on Twitter</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-sz7xmlte><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://github.com/jiayihu" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Jiayi's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://www.linkedin.com/in/jiayi-hu/" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Jiayi's LinkedIn page</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/linkedin" data-astro-cid-sz7xmlte> <path fill="currentColor" d="M13.632 13.635h-2.37V9.922c0-.886-.018-2.025-1.234-2.025-1.235 0-1.424.964-1.424 1.96v3.778h-2.37V6H8.51V7.04h.03c.318-.6 1.092-1.233 2.247-1.233 2.4 0 2.845 1.58 2.845 3.637v4.188zM3.558 4.955c-.762 0-1.376-.617-1.376-1.377 0-.758.614-1.375 1.376-1.375.76 0 1.376.617 1.376 1.375 0 .76-.617 1.377-1.376 1.377zm1.188 8.68H2.37V6h2.376v7.635zM14.816 0H1.18C.528 0 0 .516 0 1.153v13.694C0 15.484.528 16 1.18 16h13.635c.652 0 1.185-.516 1.185-1.153V1.153C16 .516 15.467 0 14.815 0z" fill-rule="nonzero" data-astro-cid-sz7xmlte></path> </svg> </a> </div> </footer>  </body></html>