<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><!-- Favicons --><link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png"><link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#5bbad5"><meta name="generator" content="Astro v4.3.2"><!-- Canonical URL --><link rel="canonical" href="https://blog.jiayihu.net/io-ts-for-express-validation/"><!-- Primary Meta Tags --><title>How to validate Express requests using io-ts</title><meta name="title" content="How to validate Express requests using io-ts"><meta name="description" content="Combine io-ts runtime type system within an Express middleware to handle request validation"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://blog.jiayihu.net/io-ts-for-express-validation/"><meta property="og:title" content="How to validate Express requests using io-ts"><meta property="og:description" content="Combine io-ts runtime type system within an Express middleware to handle request validation"><meta property="og:image" content="https://blog.jiayihu.net/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://blog.jiayihu.net/io-ts-for-express-validation/"><meta property="twitter:title" content="How to validate Express requests using io-ts"><meta property="twitter:description" content="Combine io-ts runtime type system within an Express middleware to handle request validation"><meta property="twitter:image" content="https://blog.jiayihu.net/blog-placeholder-1.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="apple-mobile-web-app-title" content="Jiayi's Chronicles"><meta name="msapplication-TileColor" content="#ffffff"><meta name="theme-color" content="#ffffff"><!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-B9J9NL8MGS"></script><style>:root{--accent: #a00;--accent-dark: rgb(110, 1, 1);--black: 15, 18, 25;--sand: 255, 252, 250;--gold: 247, 237, 213;--dark-gold: 90, 68, 13;--purple: 111, 66, 193;--gray: 160, 146, 116;--gray-light: 229, 233, 240;--gray-dark: 34, 41, 57;--gray-gradient: rgba(var(--sand), 100%), #fff;--box-shadow: 0 2px 6px rgba(var(--gray), 25%), 0 8px 24px rgba(var(--gray), 33%), 0 16px 32px rgba(var(--gray), 33%)}body{font-family:-apple-system,BlinkMacSystemFont,avenir next,avenir,helvetica neue,helvetica,ubuntu,roboto,noto,segoe ui,arial,sans-serif;margin:0;padding:0;text-align:left;background:linear-gradient(var(--gray-gradient)) no-repeat;background-size:100% 600px;word-wrap:break-word;overflow-wrap:break-word;color:rgb(var(--dark-gold));font-size:16px;line-height:1.7}main{width:720px;max-width:calc(100% - 2em);margin:auto;padding:3em 1em}h1,h2,h3,h4,h5,h6{font-family:Latin Modern,Georgia,Cambria,Times New Roman,Times,serif;font-weight:400;margin:0 0 .5rem;line-height:1.2}h1{font-size:3.052em}h2{font-size:2.441em}h3{font-size:1.953em}h4{font-size:1.563em}h5{font-size:1.25em}strong,b{font-weight:700}strong{background-color:rgba(var(--gold),100%);font-weight:400;outline:.125rem solid rgba(var(--gold),100%)}a{color:var(--accent);font-family:Latin Modern,Georgia,Cambria,Times New Roman,Times,serif}a:hover{color:var(--accent-dark);text-decoration:underline}p{margin-bottom:1em}textarea{width:100%;font-size:16px}input{font-size:16px}table{width:100%}img{max-width:100%;height:auto;border-radius:8px}code{padding:2px 5px;background-color:rgb(var(--gray-light));border-radius:2px;color:rgb(var(--purple))}pre{font-size:.875rem;padding:1.5em;border-radius:8px}pre>code{all:unset}blockquote{border-left:4px solid var(--accent);padding:0 0 0 20px;margin:0;font-size:1.333em}hr{border:none;border-top:1px solid rgb(var(--gray-light))}@media (max-width: 720px){body{font-size:16px}main{padding:1em}}.sr-only{border:0;padding:0;margin:0;position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap}.astro-code{background-color:transparent!important}footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}a[data-astro-cid-eimmu3lg]{border-bottom:4px solid transparent;color:var(--black);display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{color:var(--accent);text-decoration:underline}header[data-astro-cid-3ef6ksr2]{margin:0;padding:1rem}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1.5em}h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2],h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{font-weight:400;text-decoration:none}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:center;justify-content:space-between;flex-direction:column}@media (min-width: 720px){nav[data-astro-cid-3ef6ksr2]{flex-direction:row}}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em}nav[data-astro-cid-3ef6ksr2] .logo[data-astro-cid-3ef6ksr2]{color:var(--accent)}.internal-links[data-astro-cid-3ef6ksr2]{font-size:1rem}
main[data-astro-cid-bvzihdzo]{width:calc(100% - 2em);max-width:100%;margin:0}.header[data-astro-cid-bvzihdzo]{color:rgb(var(--dark-gold));display:flex;flex-direction:column;gap:1rem;align-items:center;font-family:Latin Modern,Georgia,Cambria,Times New Roman,Times,serif;justify-content:center;height:75vh}.title[data-astro-cid-bvzihdzo]{text-align:center}.title[data-astro-cid-bvzihdzo] h1[data-astro-cid-bvzihdzo]{font-weight:400;font-size:4rem;font-style:italic}.description[data-astro-cid-bvzihdzo]{font-size:1.25rem;width:680px;max-width:calc(100% - 2em)}.date[data-astro-cid-bvzihdzo]{margin-bottom:.5em}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}.dot-separator[data-astro-cid-bvzihdzo]:after{content:" - "}.reading-time[data-astro-cid-bvzihdzo]{text-transform:uppercase}.prose[data-astro-cid-bvzihdzo]{width:680px;max-width:calc(100% - 2em);margin:auto;padding:1em;h2,h3,h4,h5,h6{margin-top:1em;a{color:inherit;font-size:.75em;margin-left:-1em;text-decoration:none}}p{margin-bottom:2em}}
</style><script type="module" src="/_astro/hoisted.fmTBM34m.js"></script></head> <body data-astro-cid-bvzihdzo> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <h2 data-astro-cid-3ef6ksr2><a href="/" class="logo" data-astro-cid-3ef6ksr2>Jiayi&#39;s Chronicles</a></h2> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Home </a>  <a href="/about" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> About </a>  </div> </nav> </header>  <main data-astro-cid-bvzihdzo> <article data-astro-cid-bvzihdzo> <header class="header" data-astro-cid-bvzihdzo> <div class="title" data-astro-cid-bvzihdzo> <h1 data-astro-cid-bvzihdzo>How to validate Express requests using io-ts</h1> </div> <p class="description" data-astro-cid-bvzihdzo>Combine io-ts runtime type system within an Express middleware to handle request validation</p> <div class="date" data-astro-cid-bvzihdzo> <time datetime="2020-04-26T00:00:00.000Z"> Apr 26, 2020 </time>  <span class="dot-separator" data-astro-cid-bvzihdzo></span> <span class="reading-time" data-astro-cid-bvzihdzo>5 min read</span> </div> </header> <div class="prose" data-astro-cid-bvzihdzo>  <p><a href="https://github.com/gcanti/io-ts">Io-ts</a> is runtime type system which provides safe encoding and decoding, but if you landed on this page you probably already have a slight idea of what it is. As a matter of fact, I wrote this article to remind a future version of myself about how to use the library to validate the requests coming from a REST API endpoint in a <a href="https://expressjs.com/">Express.js</a> middleware. Let’s go straight to it then.</p>
<h2 id="decoder">Decoder</h2>
<p>The first code we need to write is the <a href="https://github.com/gcanti/io-ts/blob/master/Decoder.md">Decoder</a>, which will take unknown input we need to check. A <code>Decoder</code> is a runtime representation of a static type and, indeed, one of the benefits of using <code>io-ts</code> compared to popular alternatives like <a href="https://express-validator.github.io/docs/">express-validator</a> is the strong TypeScript typing we have for free.</p>
<p>Suppose we have an Express application having API endpoints for <a href="https://animal-crossing.com/">Animal Crossing</a>, just as an example since it’s my current obsession. Let’s start with the <code>Decoder</code> of an island:</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#D73A49">import</span><span style="color:#005CC5"> *</span><span style="color:#D73A49"> as</span><span style="color:#24292E"> D </span><span style="color:#D73A49">from</span><span style="color:#032F62"> 'io-ts/lib/Decoder'</span><span style="color:#24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">export</span><span style="color:#D73A49"> const</span><span style="color:#005CC5"> IslandDec</span><span style="color:#D73A49"> =</span><span style="color:#005CC5"> D</span><span style="color:#24292E">.</span><span style="color:#6F42C1">type</span><span style="color:#24292E">({</span></span>
<span class="line"><span style="color:#24292E">  fruit: </span><span style="color:#005CC5">D</span><span style="color:#24292E">.</span><span style="color:#6F42C1">literal</span><span style="color:#24292E">(</span><span style="color:#032F62">'apple'</span><span style="color:#24292E">, </span><span style="color:#032F62">'cherry'</span><span style="color:#24292E">, </span><span style="color:#032F62">'orange'</span><span style="color:#24292E">, </span><span style="color:#032F62">'peach'</span><span style="color:#24292E">, </span><span style="color:#032F62">'pear'</span><span style="color:#24292E">),</span></span>
<span class="line"><span style="color:#24292E">  hemisphere: </span><span style="color:#005CC5">D</span><span style="color:#24292E">.</span><span style="color:#6F42C1">literal</span><span style="color:#24292E">(</span><span style="color:#032F62">'north'</span><span style="color:#24292E">, </span><span style="color:#032F62">'south'</span><span style="color:#24292E">),</span></span>
<span class="line"><span style="color:#24292E">  villager: </span><span style="color:#005CC5">D</span><span style="color:#24292E">.</span><span style="color:#6F42C1">literal</span><span style="color:#24292E">(</span><span style="color:#032F62">'daisy'</span><span style="color:#24292E">, </span><span style="color:#032F62">'celeste'</span><span style="color:#24292E">, </span><span style="color:#032F62">'neither'</span><span style="color:#24292E">),</span></span>
<span class="line"><span style="color:#24292E">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/*</span></span>
<span class="line"><span style="color:#6A737D">type Island = {</span></span>
<span class="line"><span style="color:#6A737D">    fruit: "apple" | "cherry" | "orange" | "peach" | "pear";</span></span>
<span class="line"><span style="color:#6A737D">    hemisphere: "north" | "south";</span></span>
<span class="line"><span style="color:#6A737D">    villager: "daisy" | "celeste" | "neither";</span></span>
<span class="line"><span style="color:#6A737D">}</span></span>
<span class="line"><span style="color:#6A737D">*/</span></span>
<span class="line"><span style="color:#D73A49">export</span><span style="color:#D73A49"> type</span><span style="color:#6F42C1"> Island</span><span style="color:#D73A49"> =</span><span style="color:#6F42C1"> D</span><span style="color:#24292E">.</span><span style="color:#6F42C1">TypeOf</span><span style="color:#24292E">&#x3C;</span><span style="color:#D73A49">typeof</span><span style="color:#24292E"> IslandDec>;</span></span></code></pre>
<p>As you can see, by using <code>io-ts</code> we have been able to both define the <code>Decoder</code> and extract the static type using the <code>TypeOf</code> operator, without declaring the type ourselves. <code>io-ts</code> comes with built-in decoders for primitive types, whereas <code>D.type</code> allows to define an object with required fields.</p>
<p>By using the method <code>.decode</code> we can check the validity of an object.</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#24292E">IslandDec.</span><span style="color:#6F42C1">decode</span><span style="color:#24292E">({</span></span>
<span class="line"><span style="color:#24292E">  fruit: </span><span style="color:#032F62">'apples'</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#24292E">  hemisphere: </span><span style="color:#032F62">'north'</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#24292E">  villager: </span><span style="color:#032F62">'neither'</span></span>
<span class="line"><span style="color:#24292E">})</span></span></code></pre>
<p>Did you even notice where is the error? Surely, the <code>Decoder</code> was able to strictly check the input.</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#24292E">{</span></span>
<span class="line"><span style="color:#6F42C1">  value</span><span style="color:#24292E">: </span><span style="color:#032F62">'required property "fruit"'</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#6F42C1">  forest</span><span style="color:#24292E">: [</span></span>
<span class="line"><span style="color:#24292E">    {</span></span>
<span class="line"><span style="color:#24292E">      value:</span></span>
<span class="line"><span style="color:#032F62">        'cannot decode "apples", should be "apple" | "cherry" | "orange" | "peach" | "pear"'</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#24292E">      forest: []</span></span>
<span class="line"><span style="color:#24292E">    }</span></span>
<span class="line"><span style="color:#24292E">  ]</span></span>
<span class="line"><span style="color:#24292E">}</span></span></code></pre>
<h2 id="express-validator">Express validator</h2>
<p>We can now leverage our <code>Decoder</code> to use it as a <a href="https://expressjs.com/en/guide/using-middleware.html">Express middleware</a> to validate the request body of an API endpoint. We can write an utility to easily use <code>Decoders</code> as request validators.</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> { RequestHandler } </span><span style="color:#D73A49">from</span><span style="color:#032F62"> 'express'</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> { Decoder } </span><span style="color:#D73A49">from</span><span style="color:#032F62"> 'io-ts/lib/Decoder'</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> { pipe } </span><span style="color:#D73A49">from</span><span style="color:#032F62"> 'fp-ts/lib/pipeable'</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> { fold } </span><span style="color:#D73A49">from</span><span style="color:#032F62"> 'fp-ts/lib/Either'</span><span style="color:#24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">export</span><span style="color:#D73A49"> const</span><span style="color:#6F42C1"> validator</span><span style="color:#D73A49">:</span><span style="color:#24292E"> &#x3C;</span><span style="color:#6F42C1">T</span><span style="color:#24292E">>(</span><span style="color:#E36209">decoder</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> Decoder</span><span style="color:#24292E">&#x3C;</span><span style="color:#6F42C1">T</span><span style="color:#24292E">>) </span><span style="color:#D73A49">=></span><span style="color:#6F42C1"> RequestHandler</span><span style="color:#24292E">&#x3C;</span><span style="color:#6F42C1">ParamsDictionary</span><span style="color:#24292E">, </span><span style="color:#005CC5">any</span><span style="color:#24292E">, </span><span style="color:#6F42C1">T</span><span style="color:#24292E">> </span><span style="color:#D73A49">=</span><span style="color:#E36209"> decoder</span><span style="color:#D73A49"> =></span><span style="color:#24292E"> (</span></span>
<span class="line"><span style="color:#E36209">  req</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#E36209">  res</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#E36209">  next</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#24292E">) </span><span style="color:#D73A49">=></span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#D73A49">  return</span><span style="color:#6F42C1"> pipe</span><span style="color:#24292E">(</span></span>
<span class="line"><span style="color:#24292E">    decoder.</span><span style="color:#6F42C1">decode</span><span style="color:#24292E">(req.body),</span></span>
<span class="line"><span style="color:#6F42C1">    fold</span><span style="color:#24292E">(</span></span>
<span class="line"><span style="color:#E36209">      errors</span><span style="color:#D73A49"> =></span><span style="color:#24292E"> res.</span><span style="color:#6F42C1">status</span><span style="color:#24292E">(</span><span style="color:#005CC5">400</span><span style="color:#24292E">).</span><span style="color:#6F42C1">send</span><span style="color:#24292E">({ status: </span><span style="color:#032F62">'error'</span><span style="color:#24292E">, error: errors }),</span></span>
<span class="line"><span style="color:#24292E">      () </span><span style="color:#D73A49">=></span><span style="color:#6F42C1"> next</span><span style="color:#24292E">(),</span></span>
<span class="line"><span style="color:#24292E">    ),</span></span>
<span class="line"><span style="color:#24292E">  );</span></span>
<span class="line"><span style="color:#24292E">};</span></span></code></pre>
<p>Then finally we have all the elements to setup the validation in place. As mentioned, a nice benefit of using <code>io-ts</code> is having better types. In this case, <code>validator</code> returns a <code>RequestHandler&#x3C;ParamsDictionary, any, T></code> which is able to type <code>req.body</code> in the route handler, instead of being <code>any</code>.</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#24292E">app.</span><span style="color:#6F42C1">post</span><span style="color:#24292E">(</span><span style="color:#032F62">'/islands'</span><span style="color:#24292E">, </span><span style="color:#6F42C1">validator</span><span style="color:#24292E">(IslandDec), (</span><span style="color:#E36209">req</span><span style="color:#24292E">, </span><span style="color:#E36209">res</span><span style="color:#24292E">, </span><span style="color:#E36209">next</span><span style="color:#24292E">) </span><span style="color:#D73A49">=></span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#D73A49">  return</span><span style="color:#6F42C1"> addIsland</span><span style="color:#24292E">(req.body) </span><span style="color:#6A737D">// req.body is strictly typed</span></span>
<span class="line"><span style="color:#24292E">    .</span><span style="color:#6F42C1">then</span><span style="color:#24292E">(</span><span style="color:#E36209">island</span><span style="color:#D73A49"> =></span><span style="color:#24292E"> res.</span><span style="color:#6F42C1">status</span><span style="color:#24292E">(</span><span style="color:#005CC5">301</span><span style="color:#24292E">).</span><span style="color:#6F42C1">send</span><span style="color:#24292E">({ status: </span><span style="color:#032F62">'success'</span><span style="color:#24292E">, data: island }))</span></span>
<span class="line"><span style="color:#24292E">    .</span><span style="color:#6F42C1">catch</span><span style="color:#24292E">(next);</span></span>
<span class="line"><span style="color:#24292E">});</span></span></code></pre>
<h2 id="decoder-composition">Decoder composition</h2>
<p>As a final note, I also want to show how flexible the <code>io-ts</code> <code>Decoder</code> is. We can for instance define a more complex <code>Decoder</code> by composing together simpler ones.</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#D73A49">import</span><span style="color:#005CC5"> *</span><span style="color:#D73A49"> as</span><span style="color:#24292E"> D </span><span style="color:#D73A49">from</span><span style="color:#032F62"> 'io-ts/lib/Decoder'</span><span style="color:#24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">export</span><span style="color:#D73A49"> const</span><span style="color:#005CC5"> BulletinBodyDec</span><span style="color:#D73A49"> =</span><span style="color:#005CC5"> D</span><span style="color:#24292E">.</span><span style="color:#6F42C1">type</span><span style="color:#24292E">({</span></span>
<span class="line"><span style="color:#24292E">  dodo: </span><span style="color:#005CC5">D</span><span style="color:#24292E">.string,</span></span>
<span class="line"><span style="color:#24292E">  island: IslandDec,</span></span>
<span class="line"><span style="color:#24292E">  time: </span><span style="color:#005CC5">D</span><span style="color:#24292E">.string,</span></span>
<span class="line"><span style="color:#24292E">  turnipPrice: </span><span style="color:#005CC5">D</span><span style="color:#24292E">.number,</span></span>
<span class="line"><span style="color:#24292E">  description: </span><span style="color:#005CC5">D</span><span style="color:#24292E">.string,</span></span>
<span class="line"><span style="color:#24292E">  preferences: </span><span style="color:#005CC5">D</span><span style="color:#24292E">.</span><span style="color:#6F42C1">type</span><span style="color:#24292E">({</span></span>
<span class="line"><span style="color:#24292E">    concurrent: </span><span style="color:#005CC5">D</span><span style="color:#24292E">.number,</span></span>
<span class="line"><span style="color:#24292E">    queue: </span><span style="color:#005CC5">D</span><span style="color:#24292E">.number,</span></span>
<span class="line"><span style="color:#24292E">    hasFee: </span><span style="color:#005CC5">D</span><span style="color:#24292E">.boolean,</span></span>
<span class="line"><span style="color:#24292E">    isPrivate: </span><span style="color:#005CC5">D</span><span style="color:#24292E">.boolean,</span></span>
<span class="line"><span style="color:#24292E">  }),</span></span>
<span class="line"><span style="color:#24292E">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">export</span><span style="color:#D73A49"> const</span><span style="color:#005CC5"> BulletinDec</span><span style="color:#D73A49"> =</span><span style="color:#005CC5"> D</span><span style="color:#24292E">.</span><span style="color:#6F42C1">intersection</span><span style="color:#24292E">(</span></span>
<span class="line"><span style="color:#005CC5">  D</span><span style="color:#24292E">.</span><span style="color:#6F42C1">type</span><span style="color:#24292E">({</span></span>
<span class="line"><span style="color:#24292E">    id: </span><span style="color:#005CC5">D</span><span style="color:#24292E">.string,</span></span>
<span class="line"><span style="color:#24292E">    meta: </span><span style="color:#005CC5">D</span><span style="color:#24292E">.</span><span style="color:#6F42C1">type</span><span style="color:#24292E">({</span></span>
<span class="line"><span style="color:#24292E">      creationDate: </span><span style="color:#005CC5">D</span><span style="color:#24292E">.string,</span></span>
<span class="line"><span style="color:#24292E">    }),</span></span>
<span class="line"><span style="color:#24292E">  }),</span></span>
<span class="line"><span style="color:#24292E">  BulletinBodyDec,</span></span>
<span class="line"><span style="color:#24292E">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">export</span><span style="color:#D73A49"> type</span><span style="color:#6F42C1"> BulletinBody</span><span style="color:#D73A49"> =</span><span style="color:#6F42C1"> D</span><span style="color:#24292E">.</span><span style="color:#6F42C1">TypeOf</span><span style="color:#24292E">&#x3C;</span><span style="color:#D73A49">typeof</span><span style="color:#24292E"> BulletinBodyDec>;</span></span>
<span class="line"><span style="color:#D73A49">export</span><span style="color:#D73A49"> type</span><span style="color:#6F42C1"> Bulletin</span><span style="color:#D73A49"> =</span><span style="color:#6F42C1"> D</span><span style="color:#24292E">.</span><span style="color:#6F42C1">TypeOf</span><span style="color:#24292E">&#x3C;</span><span style="color:#D73A49">typeof</span><span style="color:#24292E"> BulletinDec>;</span></span></code></pre>
<p>We have defined a more complex <code>Bulletin</code> as an intersection of <code>Decoders</code> and <code>BulletinBodyDec</code> is able to reuse the previously defined <code>IslandDec</code>.</p>
<h2 id="transform-io-ts-error-towards-a-more-standard-error-response">Transform io-ts error towards a more standard error response</h2>
<p>By default, <code>io-ts</code> returns a <code>NonEmptyArray&#x3C;Tree&#x3C;string>></code> type as errors, which is an array of error trees with at least one error. The <code>Tree</code> structure is convenient to understand the hierarchy of the invalid properties, but you may wish to return a more standard error response to the client. Suppose you would like to have the following REST error response instead:</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * https://github.com/Microsoft/api-guidelines/blob/master/Guidelines.md#errorresponse--object</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"><span style="color:#D73A49">export</span><span style="color:#D73A49"> interface</span><span style="color:#6F42C1"> RestError</span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#E36209">  code</span><span style="color:#D73A49">:</span><span style="color:#032F62"> 'BadArgument'</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#E36209">  message</span><span style="color:#D73A49">:</span><span style="color:#005CC5"> string</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#E36209">  details</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> Array</span><span style="color:#24292E">&#x3C;</span><span style="color:#6F42C1">RestError</span><span style="color:#24292E">>;</span></span>
<span class="line"><span style="color:#24292E">}</span></span></code></pre>
<p>The following code shows an example of how to transform the array of error <code>Tree</code>s (the type is <code>Array&#x3C;Tree&#x3C;string>></code> aka <code>Forest&#x3C;string></code>) into a flatten array of <code>RestError</code>, by using a recursive function which is able to extract all the error messages from the forest.</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#D73A49">function</span><span style="color:#6F42C1"> getErrorValues</span><span style="color:#24292E">(</span><span style="color:#E36209">forest</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> Array</span><span style="color:#24292E">&#x3C;</span><span style="color:#6F42C1">Tree</span><span style="color:#24292E">&#x3C;</span><span style="color:#005CC5">string</span><span style="color:#24292E">>>)</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> Array</span><span style="color:#24292E">&#x3C;</span><span style="color:#005CC5">string</span><span style="color:#24292E">> {</span></span>
<span class="line"><span style="color:#D73A49">  return</span><span style="color:#24292E"> forest.</span><span style="color:#6F42C1">flatMap</span><span style="color:#24292E">(</span><span style="color:#E36209">x</span><span style="color:#D73A49"> =></span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#D73A49">    return</span><span style="color:#24292E"> x.forest.</span><span style="color:#005CC5">length</span><span style="color:#D73A49"> ?</span><span style="color:#24292E"> [x.value, </span><span style="color:#D73A49">...</span><span style="color:#6F42C1">getErrorValues</span><span style="color:#24292E">(x.forest)] </span><span style="color:#D73A49">:</span><span style="color:#24292E"> [x.value];</span></span>
<span class="line"><span style="color:#24292E">  });</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">export</span><span style="color:#D73A49"> const</span><span style="color:#6F42C1"> validator</span><span style="color:#D73A49">:</span><span style="color:#24292E"> &#x3C;</span><span style="color:#6F42C1">T</span><span style="color:#24292E">>(</span><span style="color:#E36209">decoder</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> Decoder</span><span style="color:#24292E">&#x3C;</span><span style="color:#6F42C1">T</span><span style="color:#24292E">>) </span><span style="color:#D73A49">=></span><span style="color:#6F42C1"> RequestHandler</span><span style="color:#24292E">&#x3C;</span><span style="color:#6F42C1">ParamsDictionary</span><span style="color:#24292E">, </span><span style="color:#005CC5">any</span><span style="color:#24292E">, </span><span style="color:#6F42C1">T</span><span style="color:#24292E">> </span><span style="color:#D73A49">=</span><span style="color:#E36209"> decoder</span><span style="color:#D73A49"> =></span><span style="color:#24292E"> (</span></span>
<span class="line"><span style="color:#E36209">  req</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#E36209">  res</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#E36209">  next</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#24292E">) </span><span style="color:#D73A49">=></span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#D73A49">  return</span><span style="color:#6F42C1"> pipe</span><span style="color:#24292E">(</span></span>
<span class="line"><span style="color:#24292E">    decoder.</span><span style="color:#6F42C1">decode</span><span style="color:#24292E">(req.body),</span></span>
<span class="line"><span style="color:#6F42C1">    fold</span><span style="color:#24292E">(</span></span>
<span class="line"><span style="color:#E36209">      errorForest</span><span style="color:#D73A49"> =></span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#D73A49">        const</span><span style="color:#005CC5"> details</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> Array</span><span style="color:#24292E">&#x3C;</span><span style="color:#6F42C1">RestError</span><span style="color:#24292E">> </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> getErrorValues</span><span style="color:#24292E">(errorForest).</span><span style="color:#6F42C1">map</span><span style="color:#24292E">(</span><span style="color:#E36209">message</span><span style="color:#D73A49"> =></span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#D73A49">          return</span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#24292E">            code: </span><span style="color:#032F62">'BadArgument'</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#24292E">            message,</span></span>
<span class="line"><span style="color:#24292E">          };</span></span>
<span class="line"><span style="color:#24292E">        });</span></span>
<span class="line"><span style="color:#D73A49">        const</span><span style="color:#005CC5"> error</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> RestError</span><span style="color:#D73A49"> =</span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#24292E">          code: </span><span style="color:#032F62">'BadArgument'</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#24292E">          message: </span><span style="color:#032F62">'Invalid request body'</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#24292E">          details,</span></span>
<span class="line"><span style="color:#24292E">        };</span></span>
<span class="line"><span style="color:#24292E">        </span></span>
<span class="line"><span style="color:#D73A49">        return</span><span style="color:#24292E"> res.</span><span style="color:#6F42C1">status</span><span style="color:#24292E">(</span><span style="color:#005CC5">400</span><span style="color:#24292E">).</span><span style="color:#6F42C1">send</span><span style="color:#24292E">({ status: </span><span style="color:#032F62">'error'</span><span style="color:#24292E">, error });</span></span>
<span class="line"><span style="color:#24292E">      },</span></span>
<span class="line"><span style="color:#24292E">      () </span><span style="color:#D73A49">=></span><span style="color:#6F42C1"> next</span><span style="color:#24292E">(),</span></span>
<span class="line"><span style="color:#24292E">    ),</span></span>
<span class="line"><span style="color:#24292E">  );</span></span>
<span class="line"><span style="color:#24292E">};</span></span></code></pre>   <script src="https://giscus.app/client.js" data-repo="jiayihu/blog" data-repo-id="MDEwOlJlcG9zaXRvcnk1ODc1MTUxMA==" data-category="Announcements" data-category-id="DIC_kwDOA4B6Fs4Ce90Z" data-mapping="title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="en" data-loading="lazy" crossorigin="anonymous" async></script> </div> </article> </main> <footer data-astro-cid-sz7xmlte>
&copy; 2024 Jiayi Hu. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte> <a href="https://twitter.com/jiayi0x10" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Follow Astro on Twitter</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-sz7xmlte><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://github.com/jiayihu" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Jiayi's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://www.linkedin.com/in/jiayi-hu/" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Jiayi's LinkedIn page</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/linkedin" data-astro-cid-sz7xmlte> <path fill="currentColor" d="M13.632 13.635h-2.37V9.922c0-.886-.018-2.025-1.234-2.025-1.235 0-1.424.964-1.424 1.96v3.778h-2.37V6H8.51V7.04h.03c.318-.6 1.092-1.233 2.247-1.233 2.4 0 2.845 1.58 2.845 3.637v4.188zM3.558 4.955c-.762 0-1.376-.617-1.376-1.377 0-.758.614-1.375 1.376-1.375.76 0 1.376.617 1.376 1.375 0 .76-.617 1.377-1.376 1.377zm1.188 8.68H2.37V6h2.376v7.635zM14.816 0H1.18C.528 0 0 .516 0 1.153v13.694C0 15.484.528 16 1.18 16h13.635c.652 0 1.185-.516 1.185-1.153V1.153C16 .516 15.467 0 14.815 0z" fill-rule="nonzero" data-astro-cid-sz7xmlte></path> </svg> </a> </div> </footer>  </body></html>