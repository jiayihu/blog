<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><!-- Favicons --><link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png"><link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#5bbad5"><meta name="generator" content="Astro v4.3.2"><!-- Canonical URL --><link rel="canonical" href="https://blog.jiayihu.net/testing-rxjs6/"><!-- Primary Meta Tags --><title>Testing Observables in RxJS6</title><meta name="title" content="Testing Observables in RxJS6"><meta name="description" content="Introduction to RxJS marble testing, TestScheduler and how to improve Observable testing experience"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://blog.jiayihu.net/testing-rxjs6/"><meta property="og:title" content="Testing Observables in RxJS6"><meta property="og:description" content="Introduction to RxJS marble testing, TestScheduler and how to improve Observable testing experience"><meta property="og:image" content="https://blog.jiayihu.net/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://blog.jiayihu.net/testing-rxjs6/"><meta property="twitter:title" content="Testing Observables in RxJS6"><meta property="twitter:description" content="Introduction to RxJS marble testing, TestScheduler and how to improve Observable testing experience"><meta property="twitter:image" content="https://blog.jiayihu.net/blog-placeholder-1.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="apple-mobile-web-app-title" content="Jiayi's Chronicles"><meta name="msapplication-TileColor" content="#ffffff"><meta name="theme-color" content="#ffffff"><!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-B9J9NL8MGS"></script><style>:root{--accent: #a00;--accent-dark: rgb(110, 1, 1);--black: 15, 18, 25;--sand: 255, 252, 250;--gold: 247, 237, 213;--dark-gold: 90, 68, 13;--purple: 111, 66, 193;--gray: 160, 146, 116;--gray-light: 229, 233, 240;--gray-dark: 34, 41, 57;--gray-gradient: rgba(var(--sand), 100%), #fff;--box-shadow: 0 2px 6px rgba(var(--gray), 25%), 0 8px 24px rgba(var(--gray), 33%), 0 16px 32px rgba(var(--gray), 33%)}body{font-family:-apple-system,BlinkMacSystemFont,avenir next,avenir,helvetica neue,helvetica,ubuntu,roboto,noto,segoe ui,arial,sans-serif;margin:0;padding:0;text-align:left;background:linear-gradient(var(--gray-gradient)) no-repeat;background-size:100% 600px;word-wrap:break-word;overflow-wrap:break-word;color:rgb(var(--dark-gold));font-size:16px;line-height:1.7}main{width:720px;max-width:calc(100% - 2em);margin:auto;padding:3em 1em}h1,h2,h3,h4,h5,h6{font-family:Latin Modern,Georgia,Cambria,Times New Roman,Times,serif;font-weight:400;margin:0 0 .5rem;line-height:1.2}h1{font-size:3.052em}h2{font-size:2.441em}h3{font-size:1.953em}h4{font-size:1.563em}h5{font-size:1.25em}strong,b{font-weight:700}strong{background-color:rgba(var(--gold),100%);font-weight:400;outline:.125rem solid rgba(var(--gold),100%)}a{color:var(--accent);font-family:Latin Modern,Georgia,Cambria,Times New Roman,Times,serif}a:hover{color:var(--accent-dark);text-decoration:underline}p{margin-bottom:1em}textarea{width:100%;font-size:16px}input{font-size:16px}table{width:100%}img{max-width:100%;height:auto;border-radius:8px}code{padding:2px 5px;background-color:rgb(var(--gray-light));border-radius:2px;color:rgb(var(--purple))}pre{font-size:.875rem;padding:1.5em;border-radius:8px}pre>code{all:unset}blockquote{border-left:4px solid var(--accent);padding:0 0 0 20px;margin:0;font-size:1.333em}hr{border:none;border-top:1px solid rgb(var(--gray-light))}@media (max-width: 720px){body{font-size:16px}main{padding:1em}}.sr-only{border:0;padding:0;margin:0;position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap}.astro-code{background-color:transparent!important}figcaption{font-size:.875rem;font-style:italic;text-align:right}footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}a[data-astro-cid-eimmu3lg]{border-bottom:4px solid transparent;color:var(--black);display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{color:var(--accent);text-decoration:underline}header[data-astro-cid-3ef6ksr2]{margin:0;padding:1rem}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1.5em}h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2],h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{font-weight:400;text-decoration:none}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:center;justify-content:space-between;flex-direction:column}@media (min-width: 720px){nav[data-astro-cid-3ef6ksr2]{flex-direction:row}}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em}nav[data-astro-cid-3ef6ksr2] .logo[data-astro-cid-3ef6ksr2]{color:var(--accent)}.internal-links[data-astro-cid-3ef6ksr2]{font-size:1rem}
main[data-astro-cid-bvzihdzo]{width:calc(100% - 2em);max-width:100%;margin:0}.header[data-astro-cid-bvzihdzo]{color:rgb(var(--dark-gold));display:flex;flex-direction:column;gap:1rem;align-items:center;font-family:Latin Modern,Georgia,Cambria,Times New Roman,Times,serif;justify-content:center;min-height:75vh}.title[data-astro-cid-bvzihdzo]{text-align:center}.title[data-astro-cid-bvzihdzo] h1[data-astro-cid-bvzihdzo]{font-weight:400;font-style:italic}.description[data-astro-cid-bvzihdzo]{font-size:1.125rem;width:680px;max-width:calc(100% - 2em)}.date[data-astro-cid-bvzihdzo]{margin-bottom:.5em}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}.dot-separator[data-astro-cid-bvzihdzo]:after{content:" - "}.reading-time[data-astro-cid-bvzihdzo]{text-transform:uppercase}.prose[data-astro-cid-bvzihdzo]{width:680px;max-width:calc(100% - 2em);margin:auto;padding:1em;h2,h3,h4,h5,h6{margin-top:1em;a{color:inherit;font-size:.75em;margin-left:-1em;text-decoration:none}}p{margin-bottom:2em}}
</style><script type="module" src="/_astro/hoisted.so8-tTbL.js"></script></head> <body data-astro-cid-bvzihdzo> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <h2 data-astro-cid-3ef6ksr2><a href="/" class="logo" data-astro-cid-3ef6ksr2>Jiayi&#39;s Chronicles</a></h2> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Home </a>  <a href="/about" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> About </a>  </div> </nav> </header>  <main data-astro-cid-bvzihdzo> <article data-astro-cid-bvzihdzo> <header class="header" data-astro-cid-bvzihdzo> <div class="title" data-astro-cid-bvzihdzo> <h1 data-astro-cid-bvzihdzo>Testing Observables in RxJS6</h1> </div> <p class="description" data-astro-cid-bvzihdzo>Introduction to RxJS marble testing, TestScheduler and how to improve Observable testing experience</p> <div class="date" data-astro-cid-bvzihdzo> <time datetime="2018-06-18T00:00:00.000Z"> Jun 18, 2018 </time>  <span class="dot-separator" data-astro-cid-bvzihdzo></span> <span class="reading-time" data-astro-cid-bvzihdzo>9 min read</span> </div> </header> <div class="prose" data-astro-cid-bvzihdzo>  <p>With the release of RxJS6 there has been a great improvement of Observables testing and this article will guide you in the path of using RxJS marble syntax with the latest testing APIs.<br>
In the second part, we’ll cover instead how to improve the testing developer-experience, especially if you’re not using Karma/Jasmine and you write your tests with something else like Jest, in my case, or Mocha/Tape/AVA.</p>
<h2 id="marble-syntax">Marble syntax</h2>
<p><strong>Marble diagrams</strong> are visual representations of an Observable flow to help you understand the flow of values and how an operator works. You see them everywhere in the RxJS documentation and they are very useful to convey the functioning of Observables.</p>
<p><img  src="/_astro/map.XuWKYSl__eD31J.webp" alt="Marble Diagram of .map operator" width="1280" height="540" loading="lazy" decoding="async"></p>
<p>If you’re not familiar with marble diagram, you can <a href="https://medium.com/@jshvarts/read-marble-diagrams-like-a-pro-3d72934d3ef5">read more about them here</a>.</p>
<p>So what about marble syntax? Well, put simply, it’s just an ASCII description of a marble diagram which can be used when writing about Observables.</p>
<p>The previous marble diagram of <code>.map</code> could be written as:</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span>-1 ---2 ---3 ---|</span></span>
<span class="line"><span>  .map(x => x * 2)</span></span>
<span class="line"><span>-2 ---4 ---6 ---|</span></span></code></pre>
<p>Every alphanumeric string is considered as an emitted value and hyphens <code>'-'</code> are units of time. To be precise:</p>
<ul>
<li><code>' '</code> whitespace: horizontal whitespace is ignored and can be used to help vertically align multiple marble diagrams like we did to align the first stream of values</li>
<li><code>'-'</code> frame: a unit of time</li>
<li><code>'|'</code> complete: the successful completion of an observable</li>
<li><code>'#'</code> error: an error terminating the observable</li>
<li><code>[a-z0-9]</code> e.g. ‘a’ any alphanumeric character: represents a value being emitted</li>
<li><code>()</code> sync groupings: When multiple events need to be in the same frame synchronously, parentheses are used to group those events</li>
</ul>
<p>Let’s take a step further: now the idea is using marble syntax to test Observables! Since streams are collections of async values, testing by subscribing and using classic assertions would be very difficult, counter-intuitive and unreadable. By instead taking advantage of marble syntax, we can write visually explicit tests about the flow of emitted and expected values from an Observable.</p>
<h2 id="testing-observables">Testing Observables</h2>
<p>In the next examples, we’ll use <a href="https://github.com/jiayihu/rx-polling">rx-polling</a> as use case for writing Observable tests. <code>rx-polling</code> is a library which subscribes to a <code>source$</code> Observable infinitely every N seconds and can be used with any Observable, although a polling service is usually a network request for updates (a poor man’s WebSocket).</p>
<p>Let’s see a base test for the library:</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#6F42C1">test</span><span style="color:#24292E">(</span><span style="color:#032F62">'It should poll the source$ every interval'</span><span style="color:#24292E">, () </span><span style="color:#D73A49">=></span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#24292E">  scheduler.</span><span style="color:#6F42C1">run</span><span style="color:#24292E">(</span><span style="color:#E36209">helpers</span><span style="color:#D73A49"> =></span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#D73A49">    const</span><span style="color:#005CC5"> source$</span><span style="color:#D73A49"> =</span><span style="color:#6F42C1"> of</span><span style="color:#24292E">(</span><span style="color:#005CC5">1</span><span style="color:#24292E">); </span><span style="color:#6A737D">// Observable.of(1)</span></span>
<span class="line"><span style="color:#D73A49">    const</span><span style="color:#005CC5"> polling$</span><span style="color:#D73A49"> =</span><span style="color:#6F42C1"> polling</span><span style="color:#24292E">(source$, { interval: </span><span style="color:#005CC5">2</span><span style="color:#24292E"> }).</span><span style="color:#6F42C1">pipe</span><span style="color:#24292E">(</span><span style="color:#6F42C1">take</span><span style="color:#24292E">(</span><span style="color:#005CC5">3</span><span style="color:#24292E">));</span></span>
<span class="line"><span style="color:#D73A49">    const</span><span style="color:#005CC5"> expected</span><span style="color:#D73A49"> =</span><span style="color:#032F62"> '1-1-(1|)'</span><span style="color:#24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E">    helpers.</span><span style="color:#6F42C1">expectObservable</span><span style="color:#24292E">(polling$).</span><span style="color:#6F42C1">toBe</span><span style="color:#24292E">(expected, { </span><span style="color:#005CC5">1</span><span style="color:#24292E">: </span><span style="color:#005CC5">1</span><span style="color:#24292E"> });</span></span>
<span class="line"><span style="color:#24292E">  });</span></span>
<span class="line"><span style="color:#24292E">});</span></span></code></pre>
<p>The <code>source$</code> Observable is just a stream of just 1, which can be rapresented as <code>(1|)</code>. Note that the use of <code>()</code> is important because the stream emits 1 and it completes immediately on frame zero, whereas <code>1|</code> would mean that it emits 1 at frame zero and it completes at first one.</p>
<p>A polling service would then take this Observable and repeat the subscription periodically. In this case, we are asking for a subscription every 2ms. 2ms would be too frequent for any real usage and usually, you would pass values like 1000/3000ms indeed, but here we are within a unit test and we have a different rapresentation of time. First, we don’t want to wait real time like 3 seconds and, second, <strong>a frame <code>'-'</code> equals 1ms when unit testing Observables</strong>. The marble syntax of the polling Observable would be then:</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span>(1|)                                // source$</span></span>
<span class="line"><span>  polling(source$, { interval: 2 })</span></span>
<span class="line"><span>1-1-1-1-1-1-1-1-                    // and so on infinitely</span></span>
<span class="line"><span>  .pipe(take(3))</span></span>
<span class="line"><span>1-1-(1|)</span></span></code></pre>
<p>As you can see, the final marble stream is exactly the one we declared as <code>expected</code> within the test. Now, what’s left is making an assertion about the result. The line</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#24292E">helpers.</span><span style="color:#6F42C1">expectObservable</span><span style="color:#24292E">(polling$).</span><span style="color:#6F42C1">toBe</span><span style="color:#24292E">(expected, { </span><span style="color:#005CC5">1</span><span style="color:#24292E">: </span><span style="color:#005CC5">1</span><span style="color:#24292E"> });</span></span></code></pre>
<p>serves this purpose. <code>expectObservable</code> takes an Observable as input and checks if the subscription matches the expected stream described by the marble syntax. We pass also a second parameter to <code>.toBe</code> because alphanumeric characters are interpreted as an emission of strings by default. By giving <code>{ 1: 1 }</code> we are informing rxjs that the character ‘1’ corresponds to the literal number 1.</p>
<p>But where do <code>helpers</code> come from? And what is the wrapping <code>scheduler.run</code>? Okay, let’s talk about schedulers 😱</p>
<h2 id="testscheduler">TestScheduler</h2>
<p>In computing, a <strong>scheduler</strong> is a software which schedules/organizes a series of activities in a range of time. They are extremely important in different areas of Computer Science, like the process scheduler of the OS.</p>
<p>In RxJS, a <code>Scheduler</code> (the class) is used internally by the Observables to know when to start the execution and emit values. Especially within tests, they can be used to change the “meaning of time”, by making the Observables execute synchronously instead of asynchronously, without actually waiting time. We could, for example, decide that 500ms in real-world is just 50m or even 5 ticks of Node event loop.</p>
<p>By default, Observables use <code>AsyncScheduler</code> which is based on <code>setInterval</code> for timing, but we can replace it with <code>TestScheduler</code> in our tests. Put simply, the <code>TestScheduler</code> answers the question:</p>
<ul>
<li>“What a time frame ’-’ means actually?"</li>
<li>"1 <strong>virtual</strong> millisecond”.</li>
</ul>
<p>Let’s see a more complete version of the previous test and note how everything is imported from <code>rxjs</code> without further libraries:</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> { Observable, of, timer, throwError, Observer } </span><span style="color:#D73A49">from</span><span style="color:#032F62"> 'rxjs'</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> { take, map } </span><span style="color:#D73A49">from</span><span style="color:#032F62"> 'rxjs/operators'</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> { TestScheduler } </span><span style="color:#D73A49">from</span><span style="color:#032F62"> 'rxjs/testing'</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> polling </span><span style="color:#D73A49">from</span><span style="color:#032F62"> 'rx-polling'</span><span style="color:#24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * Simple deep equal assertion.</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"><span style="color:#D73A49">function</span><span style="color:#6F42C1"> assertDeepEqual</span><span style="color:#24292E">(</span><span style="color:#E36209">actual</span><span style="color:#24292E">, </span><span style="color:#E36209">expected</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#6F42C1">  expect</span><span style="color:#24292E">(actual).</span><span style="color:#6F42C1">toEqual</span><span style="color:#24292E">(expected);</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1">describe</span><span style="color:#24292E">(</span><span style="color:#032F62">'Basic behaviour'</span><span style="color:#24292E">, </span><span style="color:#D73A49">function</span><span style="color:#24292E">() {</span></span>
<span class="line"><span style="color:#D73A49">  let</span><span style="color:#24292E"> scheduler</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> TestScheduler</span><span style="color:#24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1">  beforeEach</span><span style="color:#24292E">(() </span><span style="color:#D73A49">=></span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#24292E">    scheduler </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> new</span><span style="color:#6F42C1"> TestScheduler</span><span style="color:#24292E">(assertDeepEqual);</span></span>
<span class="line"><span style="color:#24292E">  });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1">  test</span><span style="color:#24292E">(</span><span style="color:#032F62">'It should poll the source$ every interval'</span><span style="color:#24292E">, () </span><span style="color:#D73A49">=></span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#24292E">    scheduler.</span><span style="color:#6F42C1">run</span><span style="color:#24292E">(</span><span style="color:#E36209">helpers</span><span style="color:#D73A49"> =></span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#D73A49">      const</span><span style="color:#005CC5"> source$</span><span style="color:#D73A49"> =</span><span style="color:#6F42C1"> of</span><span style="color:#24292E">(</span><span style="color:#005CC5">1</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#D73A49">      const</span><span style="color:#005CC5"> polling$</span><span style="color:#D73A49"> =</span><span style="color:#6F42C1"> polling</span><span style="color:#24292E">(source$, { interval: </span><span style="color:#005CC5">2</span><span style="color:#24292E"> }).</span><span style="color:#6F42C1">pipe</span><span style="color:#24292E">(</span><span style="color:#6F42C1">take</span><span style="color:#24292E">(</span><span style="color:#005CC5">3</span><span style="color:#24292E">));</span></span>
<span class="line"><span style="color:#D73A49">      const</span><span style="color:#005CC5"> expected</span><span style="color:#D73A49"> =</span><span style="color:#032F62"> '1-1-(1|)'</span><span style="color:#24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E">      helpers.</span><span style="color:#6F42C1">expectObservable</span><span style="color:#24292E">(polling$).</span><span style="color:#6F42C1">toBe</span><span style="color:#24292E">(expected, { </span><span style="color:#005CC5">1</span><span style="color:#24292E">: </span><span style="color:#005CC5">1</span><span style="color:#24292E"> });</span></span>
<span class="line"><span style="color:#24292E">    });</span></span>
<span class="line"><span style="color:#24292E">  });</span></span>
<span class="line"><span style="color:#24292E">});</span></span></code></pre>
<p>Woah! So much more code! But actually, it just shows how to create a <code>TestScheduler</code>, by passing a function which makes an assertion about deep equality between the actual Observable stream and the expected one. We’ll go more deeply about it in the second part of the article. Then the instance of <code>TestScheduler</code> can be used as follows:</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#24292E">scheduler.</span><span style="color:#6F42C1">run</span><span style="color:#24292E">(</span><span style="color:#E36209">helpers</span><span style="color:#D73A49"> =></span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#6A737D">  // ... some Observable testing</span></span>
<span class="line"><span style="color:#24292E">});</span></span></code></pre>
<p>This code is similar to <code>this.zone.run(...)</code> of Angular NgZone, which executes all you async code inside a “zone” which can detect changes to your application. Likewise <code>scheduler.run()</code> executes your Observables within a special “zone” where the time is controlled by <code>TestScheduler</code>.</p>
<p>The first parameter <code>helpers</code> is instead passed by the scheduler and it has different methods:</p>
<ul>
<li><code>cold(marbleDiagram: string, values?: object)</code> - creates a “cold” observable by using a marble syntax. This method is useful if you cannot create Observables using the more common static methods <code>of/fromEvent/timer/interval</code> etc.</li>
<li><code>expectObservable(actual: Observable&#x3C;T>).toBe(marbleDiagram: string, values?: object)</code> - schedules an assertion</li>
</ul>
<p>Other methods are listed in the <a href="https://github.com/ReactiveX/rxjs/blob/master/doc/marble-testing.md#api">TestScheduler API documentation</a>, including the ones for dealing with “hot” observables. If you don’t know the difference between hot &#x26; cold Observables, you can read more about the topic in <a href="https://medium.com/@benlesh/hot-vs-cold-observables-f8094ed53339">“Hot vs Cold Observables”</a>. For the sake of simplicity, we can say the cold observables are the most common ones, like <code>Observable.of(1)</code>, whereas those involved in <code>Subjects</code> are hot, but they’re not used in this guide.</p>
<p>The following example tests about error recovery in <code>rx-polling</code> and <code>helpers.cold</code> is used to create an Observable which emits 2 values and then throws.</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#6F42C1">test</span><span style="color:#24292E">(</span><span style="color:#032F62">'It should retry on error'</span><span style="color:#24292E">, () </span><span style="color:#D73A49">=></span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#24292E">  scheduler.</span><span style="color:#6F42C1">run</span><span style="color:#24292E">(</span><span style="color:#E36209">helpers</span><span style="color:#D73A49"> =></span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#D73A49">    const</span><span style="color:#005CC5"> source$</span><span style="color:#D73A49"> =</span><span style="color:#24292E"> helpers.</span><span style="color:#6F42C1">cold</span><span style="color:#24292E">(</span><span style="color:#032F62">'-1-2-#'</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#D73A49">    const</span><span style="color:#005CC5"> expected</span><span style="color:#D73A49"> =</span><span style="color:#032F62"> '-1-2- ------ -1-2- ------ -(1|)'</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">    const</span><span style="color:#005CC5"> polling$</span><span style="color:#D73A49"> =</span><span style="color:#6F42C1"> polling</span><span style="color:#24292E">(source$, { interval: </span><span style="color:#005CC5">6</span><span style="color:#24292E"> }).</span><span style="color:#6F42C1">pipe</span><span style="color:#24292E">(</span><span style="color:#6F42C1">take</span><span style="color:#24292E">(</span><span style="color:#005CC5">5</span><span style="color:#24292E">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E">    helpers.</span><span style="color:#6F42C1">expectObservable</span><span style="color:#24292E">(polling$).</span><span style="color:#6F42C1">toBe</span><span style="color:#24292E">(expected);</span></span>
<span class="line"><span style="color:#24292E">  });</span></span>
<span class="line"><span style="color:#24292E">});</span></span></code></pre>
<p>The expected result, in the previous snippet, waits for 6 frames before retrying. The same marble can be written more concisely using the new <strong>time progression syntax</strong>, by expressing it as <code>6ms</code> surrounded by a space to avoid ambiguity with a series of emitted values:</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#D73A49">const</span><span style="color:#005CC5"> expected</span><span style="color:#D73A49"> =</span><span style="color:#032F62"> '-1-2- 6ms -1-2- 6ms -(1|)'</span><span style="color:#24292E">;</span></span></code></pre>
<p>And that’s it! You should be able to finally test Observables in your application! This is just an introduction but we’ve covered a lot of concepts, so have a rest before reading the rest of the article and absolutely give it a try!</p>
<p>More information about <code>TestScheduler</code> and testing can be found in the official doc for <a href="https://github.com/ReactiveX/rxjs/blob/master/doc/marble-testing">Marble testing</a>.</p>
<hr>
<h2 id="second-part-improving-testing-experience">Second part: improving testing experience</h2>
<h3 id="testmessage-and-notification">TestMessage and Notification</h3>
<p>Did you spend some time trying testing your Observables? When you start writing RxJS tests using marbles, you’ll start to see the following diff when tests fail:</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#24292E">    Object {</span></span>
<span class="line"><span style="color:#B31D28"><span style="user-select: none;">-</span>     "frame": 11,</span></span>
<span class="line"><span style="color:#22863A"><span style="user-select: none;">+</span>     "frame": 9,</span></span>
<span class="line"><span style="color:#24292E">      "notification": Notification {</span></span>
<span class="line"><span style="color:#24292E">        "error": undefined, </span></span>
<span class="line"><span style="color:#24292E">        "hasValue": true,</span></span>
<span class="line"><span style="color:#24292E">        "kind": "N", // N -> value (next), E -> error, C -> completion</span></span>
<span class="line"><span style="color:#24292E">        "value": "1",</span></span>
<span class="line"><span style="color:#24292E">      },</span></span>
<span class="line"><span style="color:#24292E">    }</span></span></code></pre>
<p>The object is an instance of <code>TestMessage</code> describing a frame of the Observable stream. Every frame in the marble syntax is interpreted as a <code>TestMessage</code> and, when the received stream doesn’t match the expected one, the test runner will throw a diff like the previous one.</p>
<p>Basically, it states “You expected 1 at frame 11, but actually the Observable emitted it at frame 9”. Converted back in marble syntax would be:</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#24292E">// For simplicity we use '-' for the frames preceding the one thrown</span></span>
<span class="line"><span style="color:#B31D28"><span style="user-select: none;">-</span> ----------1</span></span>
<span class="line"><span style="color:#22863A"><span style="user-select: none;">+</span> --------1</span></span></code></pre>
<p>When you define your tests using marble syntax, the latter is trasformed into an array of <code>TestMessage</code> followed by a comparison between the received Observable <code>TestMessage[]</code> and the expected one. Unfortunately <code>TestMessage[]</code> is not converted back to marbles, so usually, the test runner diff can be daunting to read.</p>
<h2 id="marble-matcher">Marble matcher</h2>
<p>A <strong>“matcher”</strong> is a test runner function used to test values in different ways. Jasmine/Jest have built-in matchers for primitive values, objects, arrays etc. with different visual outputs when the test fails.</p>
<p>We can then define our custom matcher for <code>TestMessage[]</code>, which transforms them back into marbles. Fortunately, if you use Jasmine, you’re already covered with <a href="https://github.com/synapse-wireless-labs/jasmine-marbles">jasmine-marbles</a>, whereas for other test runners you can use <a href="https://github.com/cartant/rxjs-marbles">rxjs-marbles</a>.</p>
<p>I have defined my own custom matcher a long time ago, when I first published <code>rx-polling</code> a year ago, but you can obtain a similar result using the former libraries:</p>
<p><img  src="/_astro/marbles-diff.VrQkKDBn_1p4BII.webp" alt="RxJS Marble matcher" width="400" height="154" loading="lazy" decoding="async"></p>
<p>As you can see it’s much prettier than before!</p>
<h2 id="conclusion">Conclusion</h2>
<p>It was a long journey, we have covered marble syntax and how to use it for Observable testing along with <code>TestScheduler</code>. We’ve also seen how marble syntax is converted to <code>TestMessage[]</code> by RxJS and how a test matcher can improve our testing experience.</p>
<p>I hope this guide cleared some misteries around RxJS testing and will make our application more solid! More examples of Observable tests can be found in the file <a href="https://github.com/jiayihu/rx-polling/blob/master/test/index.spec.ts">rx-polling/test/index.spec.ts</a>.</p>   <script src="https://giscus.app/client.js" data-repo="jiayihu/blog" data-repo-id="MDEwOlJlcG9zaXRvcnk1ODc1MTUxMA==" data-category="Announcements" data-category-id="DIC_kwDOA4B6Fs4Ce90Z" data-mapping="title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous" async></script> </div> </article> </main> <footer data-astro-cid-sz7xmlte>
&copy; 2024 Jiayi Hu. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte> <a href="https://twitter.com/jiayi0x10" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Follow Astro on Twitter</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-sz7xmlte><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://github.com/jiayihu" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Jiayi's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://www.linkedin.com/in/jiayi-hu/" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Jiayi's LinkedIn page</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/linkedin" data-astro-cid-sz7xmlte> <path fill="currentColor" d="M13.632 13.635h-2.37V9.922c0-.886-.018-2.025-1.234-2.025-1.235 0-1.424.964-1.424 1.96v3.778h-2.37V6H8.51V7.04h.03c.318-.6 1.092-1.233 2.247-1.233 2.4 0 2.845 1.58 2.845 3.637v4.188zM3.558 4.955c-.762 0-1.376-.617-1.376-1.377 0-.758.614-1.375 1.376-1.375.76 0 1.376.617 1.376 1.375 0 .76-.617 1.377-1.376 1.377zm1.188 8.68H2.37V6h2.376v7.635zM14.816 0H1.18C.528 0 0 .516 0 1.153v13.694C0 15.484.528 16 1.18 16h13.635c.652 0 1.185-.516 1.185-1.153V1.153C16 .516 15.467 0 14.815 0z" fill-rule="nonzero" data-astro-cid-sz7xmlte></path> </svg> </a> </div> </footer>  </body></html>